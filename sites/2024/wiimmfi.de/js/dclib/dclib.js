"use strict";var dcLib_DEVELOP=0;var dcLib_Config={};var dcLib_LogList=new Set;var dcLib_LogButton={};var dcLib_LocalTooltip={delay:400};var dcLib_LocalTooltipAlias=[];var dcLib_LocalTooltipSelector=undefined;var dcLib_LocalTooltipDiabled={};var dcLib_activeElement=false;function isStrict(){return!this}function isIE(){return navigator.userAgent.indexOf("Trident/7.0")>-1}function isEdgeOrIE(){return navigator.userAgent.indexOf("Edge")>-1}function getClientSettings(){let date=new Date;let cs={time:Math.round(Date.now()/1e3),tz_off:date.getTimezoneOffset(),wd:window.innerWidth,ht:window.innerHeight,light:window.matchMedia("(prefers-color-scheme: light)").matches,dark:window.matchMedia("(prefers-color-scheme: dark)").matches,is_ie:isIE()};return cs}function getElementByIdIfString(e){return typeof e==="string"||e instanceof String?document.getElementById(e):e}function removeElement(elem){elem=getElementByIdIfString(elem);if(elem&&elem.parentElement)elem.parentElement.removeChild(elem)}function removeAllChildren(elem){elem=getElementByIdIfString(elem);if(elem)while(elem.childElementCount)elem.removeChild(elem.firstChild)}function removeFirstChildren(elem,n){elem=getElementByIdIfString(elem);if(elem){let leave=elem.childElementCount-parseInt(n===undefined?1:n);while(elem.childElementCount>leave)elem.removeChild(elem.firstChild)}}function removeLastChildren(elem,n){elem=getElementByIdIfString(elem);if(elem){let leave=elem.childElementCount-parseInt(n===undefined?1:n);while(elem.childElementCount>leave)elem.removeChild(elem.lastChild)}}function removeChildrenUntilId(elem,id){elem=getElementByIdIfString(elem);if(elem){for(let i=0;i<elem.children.length;i++)if(elem.children[i].id===id){removeFirstChildren(elem,i);break}}}function removeChildrenUntilIdInc(elem,id){elem=getElementByIdIfString(elem);if(elem){for(let i=0;i<elem.children.length;i++)if(elem.children[i].id===id)break;while(i<elem.children.length&&elem.children[i].id===id)i++;removeFirstChildren(elem,i)}}function removeChildrenFromId(elem,id){elem=getElementByIdIfString(elem);if(elem){for(let i=0;i<elem.children.length;i++)if(elem.children[i].id===id){removeLastChildren(elem,elem.children.length-i);break}}}function removeChildrenUntilClass(elem,cls){elem=getElementByIdIfString(elem);if(elem){for(let i=0;i<elem.children.length;i++)if(elem.children[i].classList.contains(cls)){removeFirstChildren(elem,i);break}}}function removeChildrenUntilClassInc(elem,id){elem=getElementByIdIfString(elem);if(elem){for(let i=0;i<elem.children.length;i++)if(elem.children[i].classList.contains(cls))break;while(i<elem.children.length&&elem.children[i].classList.contains(cls))i++;removeFirstChildren(elem,i)}}function removeChildrenFromClass(elem,cls){elem=getElementByIdIfString(elem);if(elem){for(let i=0;i<elem.children.length;i++)if(elem.children[i].classList.contains(cls)){removeLastChildren(elem,elem.children.length-i);break}}}function insertBefore(elem,anchor){elem=getElementByIdIfString(elem);anchor=getElementByIdIfString(anchor);if(elem&&anchor&&elem!=anchor){let p=anchor.parentElement;if(p)p.insertBefore(elem,anchor)}}function insertBehind(elem,anchor){elem=getElementByIdIfString(elem);anchor=getElementByIdIfString(anchor);if(elem&&anchor&&elem!=anchor){let p=anchor.parentElement;if(p){anchor=anchor.nextSibling;if(anchor)p.insertBefore(elem,anchor);else p.appendChild(elem)}}}function createElementByDef(tag,def){let e=document.createElement(tag);if(e){if(typeof def==="string"||def instanceof String)e.innerHTML=def;else{for(let j in def){switch(j){case"id":e.id=def[j];break;case"class":e.className=def[j];break;case"text":e.innerHTML=def[j];break}}}}return e}function createDummyInput(){let inp=document.createElement("input");inp.type="text";inp.style.position="fixed";inp.style.left="1em";inp.style.top="1em";let body=document.getElementsByTagName("body");body[0].appendChild(inp);return inp}function createDummyTextarea(){let inp=document.createElement("textarea");inp.style.position="fixed";inp.style.left="1em";inp.style.top="1em";let body=document.getElementsByTagName("body");body[0].appendChild(inp);return inp}function xsetClipboardText(text){let active=document.activeElement;if(dcLib_DEVELOP)console.log("active="+active.value);let inp=createDummyInput();if(inp){inp.value=text;inp.select();document.execCommand("copy");inp.remove();if(active)active.focus()}}function setClipboardText(text){let active=document.activeElement;if(dcLib_DEVELOP)console.log("active="+active.value);let inp=createDummyTextarea();if(inp){inp.innerHTML=text;inp.select();document.execCommand("copy");inp.remove();if(active)active.focus()}}function copyTextToClipboard(ev){if(ev.target.innerHTML)setClipboardText(ev.target.innerHTML)}function copyToClipboardById(id){let e=getElementByIdIfString(id);if(e)setClipboardText(e.innerHTML)}function xtrim(str){return str.replace(/\s+/g," ").trim()}function getIdByClass(elem,name){let e=getElementByIdIfString(elem);if(e&&e.classList){if(!name)name="eid-";for(let i=0;i<e.classList.length;i++)if(e.classList[i].substring(0,name.length)==name)return e.classList[i].substring(name.length)}return undefined}function toCut(num,digits){let x=parseFloat("0.5e-"+digits);return(num<0?num+x:num-x).toFixed(digits)}function cloneObjectFlat(obj){if(!obj||typeof obj!=="object")return obj;let newobj=obj.constructor();for(let elem in obj)if(obj.hasOwnProperty(elem))newobj[elem]=obj[elem];return newobj}function execFunctionByName(elem,name){if(name===undefined||name==="")return;let namespaces=name.split(".");let func=namespaces.pop();for(let i=0;i<namespaces.length;i++)elem=elem[namespaces[i]];let args=Array.prototype.slice.call(arguments,2);return elem[func].apply(elem,args)}function openWindow(param){let url,target,feat;if(typeof param=="object"){url=param.url;target=param.target||param.name;feat=param.features}else{url=param;target=undefined;feat=undefined}console.log("openWindow() "+url+", target="+target+", features="+feat);if(url)window.open(url,target,feat)}function createUniqueInt(){return createUniqueInt.count?++createUniqueInt.count:createUniqueInt.count=1}function createUniqueId(){return"dcLib_UID_"+createUniqueInt()}function getUniqueIdByInt(num){return"dcLib_UID_"+num}function appendParamToUri(uri,param){let fragment="";let pos=uri.indexOf("#");if(pos>=0){fragment=uri.substring(pos);uri=uri.substring(0,pos)}pos=uri.indexOf("?");return uri+(pos<0?"?":"&")+param+fragment}function requestPassword(id,mode,len){if(!dcLib_AjaxURI["create-pw"])dcLib_AjaxURI["create-pw"]="/ajax.php?j=create-pw";var ctrl={name:"create-pw",seq_name:"create-pw",query:"&id="+id+"&m="+mode+"&l="+len};requestAjaxObject(ctrl)}function createQueryStringByList(list,strict){let result="";for(let i=0;i<list.length;i++){let e=list[i],value=null;if(e.name){switch(e.tagName){case"TEXTAREA":value=e.value;break;case"INPUT":switch(e.type){case"text":case"hidden":case"password":value=e.value;break;case"radio":case"checkbox":if(e.checked)value=e.value?e.value:"on";break}}if(value!==null)result+="&"+(strict?encodeURIComponent(e.name):e.name)+"="+encodeURIComponent(value)}}return result}function getCurrentWord(str,index){if(index<0||index===undefined)index+=str.length;if(index>str.length||index===undefined)index=str.length;let i,j,res={str:str,index:index};for(i=index;i>0&&str[i-1]!=" "&&str[i-1]!="\t";)i--;for(j=index;j<str.length&&str[j]!=" "&&str[j]!="\t";)j++;res.from=i;res.to=j;res.word=str.substring(i,j);res.valid=i<j;return res}function getInputData(e){e=getElementByIdIfString(e);if(!e)return null;let res={value:e.value};if(e.selectionStart!==undefined){res.start=e.selectionStart;res.end=e.selectionEnd}return res}function setInputData(e,data){if(typeof data=="object"&&data.value!=undefined){e=getElementByIdIfString(e);if(e){e.value=data.value;if(data.start!==undefined&&e.setSelectionRange)e.setSelectionRange(data.start,data.end)}}}function getValueOrInner(e){if(e)return e.value!==undefined?e.value:e.innerHTML;return undefined}function setValueOrInner(e,val){if(e){if(e.value!==undefined)e.value=val;else e.innerHTML=val}}function getKeyOfEvent(ev){let key=ev.key?ev.key:ev.code;if(key=="Esc")return"Escape";if(key=="Up")return"ArrowUp";if(key=="Down")return"ArrowDown";if(key=="Left")return"ArrowLeft";if(key=="Right")return"ArrowRight";return key}function onKeyByList(ev,keys,func,arg){let key=getKeyOfEvent(ev);let ok=Array.isArray(keys)?keys.includes(ev.key):key==keys;if(ok&&(!func||func(ev,arg))){ev.stopPropagation();ev.preventDefault();return true}return false}function onKeyEnter(ev,func,arg){let key=getKeyOfEvent(ev);if(key=="Enter"&&(!func||func(ev,arg))){ev.stopPropagation();ev.preventDefault();return true}return false}function onKeyEscape(ev,func,arg){console.log("onKeyEscape()");let key=getKeyOfEvent(ev);if(key=="Escape"&&(!func||func(ev,arg))){ev.stopPropagation();ev.preventDefault();return true}return false}function isNumeric(val){return!isNaN(val)&&isFinite(val)}function getRound(obj,fixed){let res={};if(obj){if(fixed!==undefined){for(let nam in obj)if(isNumeric(obj[nam]))res[nam]=obj[nam].toFixed(fixed)}else{for(let nam in obj)if(isNumeric(obj[nam]))res[nam]=Math.round(obj[nam])}}return res}function addMessageToLog(log,msg){if(log&&msg){if(typeof msg==="object")msg=JSON.stringify(msg,null,1);let ul=log.querySelector("ul");if(ul){let li=document.createElement("li");li.innerHTML=msg;ul.appendChild(li)}else log.innerHTML+=msg+"<br>"}}function addToLog0(log,msg){log=getElementByIdIfString(log);return log?log:getElementByIdIfString("dcLib-global-log")}function addToLog(log,msg){log=getElementByIdIfString(log);if(!log)log=getElementByIdIfString("dcLib-global-log");if(log){if(log.innerHTML==""){dcLib_LogList.add(log.id);log.tabIndex=-1;log.classList.add("logging");let button="<button tabindex=-1 type=button ";log.innerHTML="<b>Logging:</b><ul class='narrow'></ul>"+button+"onclick=\"hideElement('"+log.id+"')\">Hide Log</button> "+button+'onclick="hideAllLogs()">Hide All Logs</button> '+button+"onclick=\"clearLog('"+log.id+"')\">Clear Log</button> "+button+'onclick="clearAllLogs()">Clear All Logs</button> ';if(dcLib_LogButton[log.id]){for(let i=0;i<dcLib_LogButton[log.id].length;i++){let but=dcLib_LogButton[log.id][i];log.innerHTML+=button+'onclick="'+but.js+'">'+but.but+"</button> "}}}if(msg||arguments.length>2){if(!log.dataset.timestamp||parseInt(log.dataset.timestamp)+2e3<Date.now()){let now=new Date;addMessageToLog(log,"&#128336; "+("0"+now.getHours()).slice(-2)+":"+("0"+now.getMinutes()).slice(-2)+":"+("0"+now.getSeconds()).slice(-2)+"."+("00"+now.getMilliseconds()).slice(-3))}for(let i=1;i<arguments.length;i++)addMessageToLog(log,arguments[i]);log.dataset.timestamp=Date.now();log.scrollTop=log.scrollHeight}log.style.display="block"}else if(dcLib_DEVELOP>1){if(typeof msg==="object"){console.log("addToLog:");console.log(msg)}else console.log("addToLog: "+msg)}return log}function addTimestampToLog(log,msg){log=addToLog0(log);if(log){log.dataset.timestamp=0;if(msg)addToLog(log,msg)}return log}function hideAllLogs(log){dcLib_LogList.forEach(hideElement)}function clearLog(log){log=getElementByIdIfString(log);if(log){log.innerHTML="";log.style.display="none"}return log}function clearAllLogs(log){dcLib_LogList.forEach(clearLog)}function setClassTR(tr_list,n_same){if(n_same===undefined)n_same=1;let ns=0;let rem="tr1";let add="tr0";if(typeof tr_list==="string"||tr_list instanceof String)tr_list=document.querySelectorAll(tr_list);for(let i=0;i<tr_list.length;i++){let tr=tr_list[i];if(tr.style.display!="none"){tr.classList.remove(rem);tr.classList.add(add);if(++ns>=n_same){ns=0;let temp=rem;rem=add;add=temp}}}}function dcLibPosition(elem){this.getBoundingPos(elem)}dcLibPosition.prototype.reset=function(){this.mode=false;this.x0=0;this.y0=0;this.wd=0;this.ht=0;this.twd=0;this.tht=0;this.left=0;this.top=0;this.right=0;this.bottom=0;return false};dcLibPosition.prototype.getViewPort=function(){this.reset();this.mode="pos";this.wd=this.twd=window.innerWidth;this.ht=this.tht=window.innerHeight;this.left=this.x0;this.right=this.x0+this.twd;this.top=this.y0;this.bottom=this.y0+this.tht;return true};dcLibPosition.prototype.getScrollPos=function(elem){elem=getElementByIdIfString(elem);if(elem){this.mode="scroll";this.x0=elem.scrollLeft;this.y0=elem.scrollTop;this.wd=elem.clientWidth;this.ht=elem.clientHeight;this.twd=elem.scrollWidth;this.tht=elem.scrollHeight;this.left=0;this.top=0;this.right=0;this.bottom=0;return true}return this.reset()};dcLibPosition.prototype.getBoundingPos=function(elem){elem=getElementByIdIfString(elem);if(elem){let rect=elem.getBoundingClientRect();if(rect){this.mode="pos";this.x0=rect.x;this.y0=rect.y;this.wd=this.twd=rect.width;this.ht=this.tht=rect.height;this.left=rect.left;this.top=rect.top;this.right=rect.right;this.bottom=rect.bottom;return true}}return this.reset()};dcLibPosition.prototype.round=function(){this.mode=round(this.mode);this.x0=round(this.x0);this.y0=round(this.y0);this.wd=round(this.wd);this.ht=round(this.ht);this.twd=round(this.twd);this.tht=round(this.tht);this.left=round(this.left);this.top=round(this.top);this.right=round(this.right);this.bottom=round(this.bottom)};dcLibPosition.prototype.getRound=function(){let res=new dcLibPosition;res.mode=round(this.mode);res.x0=round(this.x0);res.y0=round(this.y0);res.wd=round(this.wd);res.ht=round(this.ht);res.twd=round(this.twd);res.tht=round(this.tht);res.left=round(this.left);res.top=round(this.top);res.right=round(this.right);res.bottom=round(this.bottom);return res};function getViewPort(){let pos=new dcLibPosition;pos.getViewPort();return pos}function getScrollPos(elem){let pos=new dcLibPosition;pos.getScrollPos(elem?elem:document.documentElement);return pos}function getBoundingPos(elem){let pos=new dcLibPosition;pos.getBoundingPos(elem?elem:document.documentElement);return pos}function centerElement(elem,dest,limit){if(!(dest instanceof dcLibPosition))dest=getBoundingPos(dest);let pos=getBoundingPos(elem);if(!dest||dest.mode!=="pos"||!pos||pos.mode!=="pos")return false;let dx=(dest.right+dest.left-pos.right-pos.left)/2;let dy=(dest.bottom+dest.top-pos.bottom-pos.top)/2;return moveElementByXY(elem,dx,dy,limit)}function centerElementH(elem,dest,limit){if(!(dest instanceof dcLibPosition))dest=getBoundingPos(dest);let pos=getBoundingPos(elem);if(!dest||dest.mode!=="pos"||!pos||pos.mode!=="pos")return false;let dx=(dest.right+dest.left-pos.right-pos.left)/2;return moveElementByXY(elem,dx,0,limit)}function centerElementV(elem,dest,limit){if(!(dest instanceof dcLibPosition))dest=getBoundingPos(dest);let pos=getBoundingPos(elem);if(!dest||dest.mode!=="pos"||!pos||pos.mode!=="pos")return false;let dy=(dest.bottom+dest.top-pos.bottom-pos.top)/2;return moveElementByXY(elem,0,dy,limit)}function moveElementInto(elem,dest,limit){if(!(dest instanceof dcLibPosition))dest=getBoundingPos(dest);let pos=getBoundingPos(elem);if(!dest||dest.mode!=="pos"||!pos||pos.mode!=="pos")return false;let dx=movePos(pos.left,pos.right,dest.left,dest.right)-pos.left;let dy=movePos(pos.top,pos.bottom,dest.top,dest.bottom)-pos.top;return moveElementByXY(elem,dx,dy,limit)}function moveElementIntoH(elem,dest,limit){if(!(dest instanceof dcLibPosition))dest=getBoundingPos(dest);let pos=getBoundingPos(elem);if(!dest||dest.mode!=="pos"||!pos||pos.mode!=="pos")return false;let dx=movePos(pos.left,pos.right,dest.left,dest.right)-pos.left;return moveElementByXY(elem,dx,0,limit)}function moveElementIntoV(elem,dest,limit){if(!(dest instanceof dcLibPosition))dest=getBoundingPos(dest);let pos=getBoundingPos(elem);if(!dest||dest.mode!=="pos"||!pos||pos.mode!=="pos")return false;let dy=movePos(pos.top,pos.bottom,dest.top,dest.bottom)-pos.top;return moveElementByXY(elem,0,dy,limit)}function movePos(e1,e2,d1,d2){let es=e2-e1;let ds=d2-d1;if(es<=ds){if(e1<=d1)return d1;if(e2<=d2)return e1;return d2-es}if(e1>=d1)return d1;if(e2>=d2)return e1;return d2-es}function moveElementByXY(elem,x,y,limit){elem=getElementByIdIfString(elem);if(elem){if(limit){let pos=getBoundingPos(elem);x=Math.max(Math.min(x,limit.right-pos.right-.5),limit.left-pos.left+.5);y=Math.max(Math.min(y,limit.bottom-pos.bottom-.5),limit.top-pos.top+.5)}x=Math.round(x);y=Math.round(y);if(x||y){let style=window.getComputedStyle(elem);elem.style.left=x+parseFloat(style.left)+"px";elem.style.top=y+parseFloat(style.top)+"px";elem.style.right="auto";elem.style.bottom="auto";return true}}return false}function moveElementToXY(elem,x,y){elem=getElementByIdIfString(elem);if(elem){let style=window.getComputedStyle(elem);let parent=elem.parentElement;if(parent!=document.body){parent.removeChild(elem);document.body.appendChild(elem)}let pos=getBoundingPos(document.body);x-=pos.x0;y-=pos.y0;elem.style.position="absolute";elem.style.left=Math.round(x)+"px";elem.style.top=Math.round(y)+"px";elem.style.right="auto";elem.style.bottom="auto";return true}return false}function cancelLocalTooltip(){if(dcLib_LocalTooltip.timer){addToLog(dcLib_LocalTooltip.log,"cancelLocalTooltip(), cancel timer");clearTimeout(dcLib_LocalTooltip.timer);delete dcLib_LocalTooltip.timer}if(dcLib_LocalTooltip.div){addToLog(dcLib_LocalTooltip.log,"cancelLocalTooltip(), delete div");document.body.removeChild(dcLib_LocalTooltip.div);delete dcLib_LocalTooltip.div}if(dcLib_LocalTooltip.elem)delete dcLib_LocalTooltip.elem}window.addEventListener("scroll",cancelLocalTooltip);function disableLocalTooltip(name){cancelLocalTooltip();dcLib_LocalTooltipDiabled[name]=true}function enableLocalTooltip(name){cancelLocalTooltip();delete dcLib_LocalTooltipDiabled[name]}function viewLocalTooltip(e){if(e&&e!==dcLib_LocalTooltip.elem){cancelLocalTooltip();if(!Object.keys(dcLib_LocalTooltipDiabled).length){let body=document.body.getBoundingClientRect();let rect=e.getBoundingClientRect();if(dcLib_LocalTooltip.log)addToLog(dcLib_LocalTooltip.log,"viewLocalTooltip: "+e.dataset.tooltip);let div=document.createElement("div");div.classList.add("local-tooltip");div.style.position="fixed";div.style.top=rect.bottom+2+"px";div.style.bottom="auto";div.style.left="3px";div.style.right="auto";div.style.zIndex=2e3;let content=dcLib_LocalTooltipAlias[e.dataset.tooltip]||e.dataset.tooltip;if(content.substring(0,2)=="c|"){div.style.textAlign="center";content=content.substring(2)}let div2=document.createElement("div");div2.innerHTML=content;div.appendChild(div2);document.body.appendChild(div);centerElementH(div,e,body);moveElementInto(div,getViewPort());dcLib_LocalTooltip.div=div;dcLib_LocalTooltip.elem=e}}}function triggerLocalTooltip(ev){let e=ev.target;while(e&&!e.dataset.tooltip)e=e.parentElement;if(e&&e!==dcLib_LocalTooltip.elem){if(dcLib_LocalTooltip.delay>0){cancelLocalTooltip();dcLib_LocalTooltip.timer=setTimeout(function(){viewLocalTooltip(e)},dcLib_LocalTooltip.delay)}else viewLocalTooltip(e)}}function registerLocalTooltips(selector,auto_update){cancelLocalTooltip();if(selector===undefined||selector==="")selector="[title],[data-tooltip]";if(auto_update)dcLib_LocalTooltipSelector=selector;let count=0;forEachSelector(selector,function(e,a){if(e.title){if(!e.dataset.tooltip)e.dataset.tooltip=e.title.replace(/\n/g,"<br>");e.title=""}if(e.dataset.tooltip){count++;e.addEventListener("mouseover",triggerLocalTooltip);e.addEventListener("mouseleave",cancelLocalTooltip)}});dcLib_LocalTooltip.log=addToLog("log-tooltip","registerLocalTooltips( "+selector+" ) N="+count);if(dcLib_DEVELOP)console.log("registerLocalTooltips( "+selector+", "+auto_update+" ) N="+count)}function registerDataRate(){let count=0;forEachSelector("[data-rate]",function(e,a){let par=e.dataset.rate.split(",",2);if(par[0]){count++;delete e.dataset.rate;let rate=par[0]+"%";let d1=document.createElement("div");let d2=document.createElement("div");d1.style.width=rate;d2.innerHTML=e.innerHTML;e.innerHTML="";e.classList.add("data-rate");if(par[1])e.classList.add(par[1]);e.appendChild(d1);e.appendChild(d2);if(!e.title)e.title=rate}});if(dcLib_DEVELOP)console.log("registerDataRate() N="+count)}function registerDataRate1(){let count=0;forEachSelector("[data-rate]",function(e,a){let rate=e.dataset.rate;if(rate){count++;delete e.dataset.rate;let d1=document.createElement("div");let d2=document.createElement("div");d1.style.width=rate+"%";d2.innerHTML=e.innerHTML;e.innerHTML="";e.classList.add("data-rate");e.appendChild(d1);e.appendChild(d2);if(!e.title)e.title=rate+"%"}});if(dcLib_DEVELOP)console.log("registerDataRate() N="+count)}function forEachHelper(getfunc,list,func,arg,log){let mySet=new Set;if(Array.isArray(list)){for(let i=0;i<list.length;i++){let l=getfunc(list[i]);for(let j=0;j<l.length;j++)mySet.add(l[j])}}else if(list){let l=getfunc(list);for(let j=0;j<l.length;j++)mySet.add(l[j])}if(log)mySet.forEach(function(x){addToLog(log,"> "+x.id)});mySet.forEach(function(x){func(x,arg)})}function forEachId(list,func,arg){forEachHelper(function(a){return[document.getElementById(a)]},list,func,arg)}function forEachClass(list,func,arg){forEachHelper(function(a){return document.getElementsByClassName(a)},list,func,arg)}function forEachName(list,func,arg){forEachHelper(function(a){return document.getElementsByName(a)},list,func,arg)}function forEachTag(list,func,arg){forEachHelper(function(a){return document.getElementsByTagName(a)},list,func,arg)}function forEachSelector(list,func,arg){forEachHelper(function(a){return document.querySelectorAll(a)},list,func,arg)}function forEachElemSelector(elem,list,func,arg){forEachHelper(function(a){return elem.querySelectorAll(a)},list,func,arg)}function setFocus(id,select,log){let e=getElementByIdIfString(id);if(e){e.focus();if(select&&e.value&&e.value.length&&e.setSelectionRange){e.setSelectionRange(0,e.value.length);addToLog(log,"setFocus("+id+") + select(all)")}else if(1&&e.tagName=="SELECT"){console.log("set focus @SELECT");var event=new Event("click");e.dispatchEvent(event)}else addToLog(log,"setFocus("+id+")")}}function setFocusForce(id,select,log){let e=getElementByIdIfString(id);if(e){setFocus(e,select,log);if(e!=document.active)setTimeout(function(){setFocus(e,select,log)},1)}}function sortByTabindex(e1,e2){let a=e1.tabIndex||1;let b=e2.tabIndex||1;return a<b?-1:a<b}function getFocusableElements(base,active){base=getElementByIdIfString(base);if(!base)base=document;if(!active)active=document.activeElement;let sel='a, button, input[type=text], textarea, [tabindex]:not([tabindex="-1"])';let res={active:null,prev:null,next:null,entry:null};res.list=Array.prototype.filter.call(base.querySelectorAll(sel),function(e){return!e.disabled&&e.style.visibility!="hidden"&&(e.offsetWidth>0||e.offsetHeight>0)||e===active});if(!res.list.length&&base!=document)res.list=[base];if(res.list.length){res.list.sort(sortByTabindex);res.index=res.list.indexOf(active);if(res.index<0)res.entry=res.list[0];else{res.entry=res.active=res.list[res.index];res.prev=res.list[(res.index||res.list.length)-1];let next=res.index+1;res.next=res.list[next==res.list.length?0:next]}}if(dcLib_DEVELOP)console.log("getFocusableElements()",res);return res}function focusNextElement(base,active){let focusable=getFocusableElements(base,active);if(focusable.next){focusable.next.focus();let e=document.activeElement;if(e&&e!==focusable.active)setFocus(e,true)}}function nextElementOnEnter(ev){let key=getKeyOfEvent(ev);if(key=="Enter"){ev.stopPropagation();ev.preventDefault();focusNextElement(ev.target.form,ev.target);return true}return false}function preventSubmitOnEnter(base){if(!base)base=document;forEachElemSelector(base,"input:not([type=submit])",function(e){e.addEventListener("keydown",nextElementOnEnter)})}function checkElement(id){let e=getElementByIdIfString(id);if(e)e.checked=true}function checkSelector(sel){forEachSelector(sel,checkElement)}function uncheckElement(id,except){let e=getElementByIdIfString(id);if(e&&(!except||e!=getElementByIdIfString(except)))e.checked=false}function uncheckSelector(sel,except){forEachSelector(sel,uncheckElement,except)}function clearCheckboxGroup(ev){if(ev.target.checked){let group=ev.target.dataset.clearcheckbox;if(group){forEachSelector('input[type="checkbox"][data-clearcheckbox="'+group+'"]',function(e){e.checked=false});ev.target.checked=true}}}function isRadioSelected(sel){let e=document.querySelector(sel);return e&&e.checked}function getRadioButtonsByName(name){let radio={first:null,checked:null,active:null,entry:null,n_enabled:0};radio.list=document.querySelectorAll('input[type=radio][name="'+name+'"]');for(let i=0;i<radio.list.length;i++){let e=radio.list[i];if(!e.disabled){radio.n_enabled++;if(radio.first===null)radio.first=i;if(e.checked)radio.checked=i;if(e==document.activeElement)radio.active=i}}if(radio.active!==null)radio.entry=radio.active;else if(radio.checked!==null)radio.entry=radio.checked;else if(radio.first!==null)radio.entry=radio.first;return radio}function setRadioFocus(name,log){let radio=getRadioButtonsByName(name);if(radio.active===null&&radio.entry!==null){radio.list[radio.entry].focus();addToLog(log,"setRadioFocus("+name+") index="+radio.entry)}return radio}function selectRadioByValue(name,value,label_class){let radio=getRadioButtonsByName(name);if(label_class)for(let i=0;i<radio.list.length;i++)removeClassFromLabelFor(radio.list[i].id,label_class);for(let i=0;i<radio.list.length;i++)if(radio.list[i].value==value){radio.list[i].checked=true;addClassToLabelFor(radio.list[i].id,label_class);return true}return false}function enableRadio(name,enable,except_checked){if(enable!==undefined&&!enable)return disableRadio(name,except_checked);let radio=getRadioButtonsByName(name);for(let i=0;i<radio.list.length;i++)radio.list[i].disabled=false}function disableRadio(name,except_checked){let radio=getRadioButtonsByName(name);for(let i=0;i<radio.list.length;i++)if(!except_checked||!radio.list[i].checked)radio.list[i].disabled=true}function removeClassFromLabelFor(id,cls){if(id&&cls)forEachSelector("label[for="+id+"]",function(e){e.classList.remove(cls)})}function addClassToLabelFor(id,cls){if(id&&cls)forEachSelector("label[for="+id+"]",function(e){e.classList.add(cls)})}function dcLibStorage(){}dcLibStorage.prototype.store=function(name,val,overwrite){if(overwrite||this[name]==undefined)this[name]=val;return this};dcLibStorage.prototype.get=function(name,default_val){return this[name]||default_val};dcLibStorage.prototype.create=function(name,default_val){return this[name]||(this[name]=default_val)};function getElementStorage(e){if(e){if(typeof e.dcLib!=="object")e.dcLib=new dcLibStorage;return e.dcLib}return new dcLibStorage}function getElementData(e,name,default_val){return e&&e.dcLib&&e.dcLib.get(name,default_val)||default_val}function createElementData(e,name,default_val){return getElementStorage(e).create(name,default_val)}function storeElementData(e,name,val,overwrite){if(e){if(typeof e.dcLib!=="object")e.dcLib=new dcLibStorage;e.dcLib.store(name,val,overwrite)}}function storeDisplayMode(e,mode,overwrite){if(e){if(!mode)mode=window.getComputedStyle(e,null).getPropertyValue("display");if(mode&&mode!="none")storeElementData(e,"display",mode,overwrite)}}function saveDisplayMode(id){storeDisplayMode(getElementByIdIfString(id))}function displayElement(id,val){let e=getElementByIdIfString(id);if(e)e.style.display=val}function displaySelector(list){for(let sel in list)forEachSelector(sel,function(e,a){e.style.display=a},list[sel])}function showElement(id,val){let e=getElementByIdIfString(id);if(e)e.style.display=val||getElementData(e,"display","block")}function showSelector(show,val){if(val)forEachSelector(show,displayElement,val);else forEachSelector(show,showElement)}function hideElement(id){let e=getElementByIdIfString(id);if(e){if(!e.dcLib||!e.dcLib.display)storeDisplayMode(e);e.style.display="none"}}function hideShowSelector(hide,show,val){forEachSelector(hide,hideElement);if(show)showSelector(show,val)}function clearElement(id){let e=getElementByIdIfString(id);if(e){e.innerHTML="";if(e.checked)e.checked=false;if(e.value&&e.getAttribute("type")=="text")e.value=""}}function clearSelector(sel,check){forEachSelector(sel,clearElement);if(check)forEachSelector(check,checkElement)}function visibleElement(id){let e=getElementByIdIfString(id);if(e)e.style.visibility="visible"}function visibleSelector(sel){forEachSelector(sel,visibleElement)}function invisibleElement(id){let e=getElementByIdIfString(id);if(e)e.style.visibility="hidden"}function invisibleSelector(sel){forEachSelector(sel,invisibleElement)}function hideShowElement(hide,show){let h=getElementByIdIfString(hide);if(h)h.style.display="none";let s=getElementByIdIfString(show);if(s)s.style.display="block"}function toggleElement(id){let e=getElementByIdIfString(id);if(e)e.style.display=e.style.display==="block"?"none":"block"}function toggleElementAndButton(id,id_but,t_show,t_hide,tog_class){let b=getElementByIdIfString(id_but);let e=getElementByIdIfString(id);if(!e.style.display||e.style.display==="none"){showElement(e);b.innerHTML=t_show;if(tog_class)b.className="hide-element"}else{hideElement(e);b.innerHTML=t_hide;if(tog_class)b.className="show-element"}}function disableElement(id){let e=getElementByIdIfString(id);if(e)e.disabled=true}function disableSelector(sel){forEachSelector(sel,disableElement)}function enableElement(id){let e=getElementByIdIfString(id);if(e)e.disabled=false}function enableSelector(sel){forEachSelector(sel,enableElement)}function showElements(){for(let i=0;i<arguments.length;i++)showElement(arguments[i])}function hideElements(){for(let i=0;i<arguments.length;i++)hideElement(arguments[i])}function hideShowElements(){if(arguments.length>0){hideElement(arguments[0]);for(let i=1;i<arguments.length;i++)showElement(arguments[i])}}function toggleElements(){for(let i=0;i<arguments.length;i++)toggleElement(arguments[i])}function toggleElementsByFirst(){if(arguments.length>0){let m1,m2,e=getElementByIdIfString(arguments[0]);if(e.style.display==="block"){m1="none";m2="block"}else{m1="block";m2="none"}e.style.display=m1;for(let i=1;i<arguments.length;i++){id=arguments[i];if(id.substring(0,1)=="-")document.getElementById(id.substring(1)).style.display=m2;else document.getElementById(id).style.display=m1}}}function analyseTabindex(base){base=base?getElementByIdIfString(base):document;let res={base:base,current:null,prev:null,next:null,list:null};if(base){let list=res.base.querySelectorAll("[tabindex]")}return res}function clearClassElement(id){let e=getElementByIdIfString(id);if(e)e.className=""}function clearClassSelector(sel){forEachSelector(sel,clearClassElement)}function setClassElement(id,cls){let e=getElementByIdIfString(id);if(e&&cls){e.className="";if(!Array.isArray(cls))cls=cls.split(" ");for(let i=0;i<cls.length;i++)e.classList.add(cls[i])}}function setClassSelector(sel,cls){forEachSelector(sel,setClassElement,cls)}function addClassElement(id,cls){let e=getElementByIdIfString(id);if(e){if(!Array.isArray(cls))cls=cls.split(" ");for(let i=0;i<cls.length;i++)e.classList.add(cls[i])}}function addClassSelector(sel,cls){forEachSelector(sel,addClassElement,cls)}function removeClassElement(id,cls){let e=getElementByIdIfString(id);if(e){if(!Array.isArray(cls))cls=cls.split(" ");for(let i=0;i<cls.length;i++)e.classList.remove(cls[i])}}function removeClassSelector(sel,cls){forEachSelector(sel,removeClassElement,cls)}function toggleClassElement(id,cls){let e=getElementByIdIfString(id);if(e){if(!Array.isArray(cls))cls=cls.split(" ");for(let i=0;i<cls.length;i++)e.classList.toggle(cls[i])}}function toggleClassSelector(sel,cls){forEachSelector(sel,toggleClassElement,cls)}function addEventOnLoad(func){if(window.addEventListener)window.addEventListener("load",func);else if(window.attachEvent)window.attachEvent("onload",func);else if(document.addEventListener)document.addEventListener("load",func);else if(document.attachEvent)document.attachEvent("onload",func)}function addEventListenerById(elem,event,func){elem=getElementByIdIfString(elem);if(elem)elem.addEventListener(event,func)}function addEventListenerByClass(list,event,func){forEachClass(list,function(e){e.addEventListener(event,func)})}function addEventListenerBySelector(list,event,func){forEachSelector(list,function(e){e.addEventListener(event,func)})}function createCustomEvent(name,bubbles,cancelable,detail){bubbles=Boolean(bubbles);cancelable=Boolean(cancelable);if(!detail)detail={log:"event-log"};else if(!detail.log&&!detail.log)detail.log="event-log";if(dcLib_DEVELOP&&detail.log)addToLog(detail.log,"â˜Ž createCustomEvent("+name+") bubbles="+bubbles+", cancelable="+cancelable);if(isIE()){let event=document.createEvent("Event");event.initEvent(name,bubbles,cancelable);event.detail=detail;return event}let init={bubbles:bubbles,cancelable:cancelable,detail:detail};return new CustomEvent(name,init)}function setupEventActivate(){if(dcLib_activeElement===false){addToLog("event-log","â˜Ž setupEventActivate()");dcLib_activeElement={target:null,frame:null,label_id:null,prev_target:null};document.addEventListener("focus",manageEventActivate,true)}forEachClass("dclib-is-frame",function(e){e.classList.remove("dclib-is-frame");e.addEventListener("dc_findframe",onFindFrame)})}function manageEventActivate(ev){let active=document.activeElement;if(active&&active!=dcLib_activeElement.target){dcLib_activeElement.prev_target=dcLib_activeElement.target;let detail={oldtarget:dcLib_activeElement.target,newtarget:active,oldframe:dcLib_activeElement.frame,newframe:null,highlight_frame:true,prevent:false,focus_on_prevent:dcLib_activeElement.target,event:ev};let cev=createCustomEvent("dc_findframe",true,true,detail);active.dispatchEvent(cev);if(dcLib_activeElement.frame&&dcLib_activeElement.frame!=detail.newframe){cev=createCustomEvent("dc_leaveframe",true,false,detail);dcLib_activeElement.frame.dispatchEvent(cev)}if(!detail.prevent){if(dcLib_activeElement.target){cev=createCustomEvent("dc_leavetarget",true,false,detail);dcLib_activeElement.target.dispatchEvent(cev)}if(!detail.prevent){if(dcLib_activeElement.frame)dcLib_activeElement.frame.classList.remove("dclib-active-frame");if(detail.newframe&&detail.highlight_frame)detail.newframe.classList.add("dclib-active-frame");if(dcLib_activeElement.target&&dcLib_activeElement.target!=document.activeElement){dcLib_activeElement.target.classList.remove("dclib-active-target");document.activeElement.classList.add("dclib-active-target")}cev=createCustomEvent("dc_entertarget",true,false,detail);document.activeElement.dispatchEvent(cev);if(detail.newframe&&detail.newframe!=dcLib_activeElement.frame){cev=createCustomEvent("dc_enterframe",true,false,detail);detail.newframe.dispatchEvent(cev)}dcLib_activeElement.target=document.activeElement;dcLib_activeElement.frame=detail.newframe}}if(detail.prevent){ev.stopPropagation();ev.preventDefault();if(detail.focus_on_prevent)setTimeout(function(){detail.focus_on_prevent.focus()},1)}else{if(dcLib_activeElement.label_id!=document.activeElement.id){if(dcLib_activeElement.label_id){forEachSelector("label[for="+dcLib_activeElement.label_id+"]",function(e){e.classList.remove("dclib-active-label")});dcLib_activeElement.label_id=null}if(document.activeElement.id){dcLib_activeElement.label_id=document.activeElement.id;forEachSelector("label[for="+dcLib_activeElement.label_id+"]",function(e){e.classList.add("dclib-active-label")})}}}}}function preventActivation(ev,focus,log){console.log("â˜Ž preventActivation(), detail="+typeof ev.detail+", have_focus="+!!focus);addToLog(log,"â˜Ž preventActivation(), detail="+typeof ev.detail+", have_focus="+!!focus);if(typeof ev.detail=="object"){ev.detail.prevent=true;if(focus)ev.detail.focus_on_prevent=focus}}const DC_ISACT_FOUND=1;const DC_ISACT_DOC=2;const DC_ISACT_TARGET=4;const DC_ISACT_FRAME=8;function isActivated(e){let stat=0;e=getElementByIdIfString(e);if(e){stat=DC_ISACT_FOUND;if(e==document.activeElement)stat=stat|DC_ISACT_DOC;if(dcLib_activeElement){if(e==dcLib_activeElement.target)stat=stat|DC_ISACT_TARGET;if(e==dcLib_activeElement.frame)stat=stat|DC_ISACT_FRAME}}return stat}function onFindFrame(ev,log){if(log)addToLog(log,"â˜Ž onFindFrame("+ev.currentTarget.id+")");ev.detail.newframe=ev.currentTarget;ev.stopPropagation();ev.preventDefault()}function scrollHashToScreen(dist){if(window.location.hash){let hash=window.location.hash.substring(1);let e=document.getElementById(hash);if(e){let pos=getBoundingPos(e);if(pos.y0>=-5&&pos.y0<dist)window.scrollBy(0,pos.y0-dist)}}}function scrollHashToScreenById(id,add){let e=document.getElementById(id);if(e){let pos=getBoundingPos(e);let dist=pos.bottom;if(add)dist+=add;scrollHashToScreen(dist)}}function decodeEscapeAt(str){return str.replaceAll("@2",'"').replaceAll("@1","'").replaceAll("@B","\\").replaceAll("@A","@")}function execLinkPar(ev,val){const par=JSON.parse(atob(val));if(dcLib_DEVELOP)console.log("execLinkPar=",par);var open=par.open==undefined?ev.ctrlKey||ev.shiftKey:par.open;if(open){let target;if(ev.ctrlKey&&ev.shiftKey)target=par.target2||"execLink2";else target=par.target||(ev.shiftKey?"execLink1":undefined);window.open(par.link,target,par.features)}else{par.link.replace(/^\//,"");window.location.assign(par.link)}}function javascriptEnabled(){forEachClass("if-js-disabled",function(e){e.style.display="none"});forEachClass("if-js-enabled",function(e){e.style.display=e.tagName=="DIV"?"block":"inline"})}addEventOnLoad(javascriptEnabled);var dcLib_AjaxURI={"-":"/ajax.php?ajax=-"};var dcLib_AjaxUsePost={};var dcLib_AjaxUsePostDef=false;var dcLib_AjaxObj={};var dcLib_AjaxSeqNum=0;var dcLib_AjaxSeq={};var dcLib_AjaxDelay={};var dcLib_AutoUpdate={};var dcLib_TooltipDelay=250;function sendClientSettings(uri){let cs=JSON.stringify(getClientSettings());console.log("sendClientSettings("+uri+")",cs);var req=new XMLHttpRequest;req.open("POST",uri,true);req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");req.send("settings="+cs)}function AddAutoUpdate(key,func,arg){if(dcLib_DEVELOP)console.log("AddAutoUpdate("+key+")");dcLib_AutoUpdate[key]={func:func,arg:arg};console.log(dcLib_AutoUpdate)}function ExecuteAutoUpdate(){let list=cloneObjectFlat(dcLib_AutoUpdate);if(dcLib_DEVELOP)console.log("ExecuteAutoUpdate() N="+Object.keys(list).length+" "+JSON.stringify(Object.keys(list)));for(let key in dcLib_AutoUpdate)list[key].func(list[key].arg)}function registerDataHref(){let count=0;forEachSelector("a[data-href]",function(e,a){if(e.dataset.href){e.href=e.dataset.href;delete e.dataset.href;count++}});if(dcLib_DEVELOP&&count)console.log("enableDataHref() N="+count)}addEventOnLoad(registerDataHref);AddAutoUpdate("dcLibDataHref",registerDataHref,false);function processJob(job,log,ctrl){if(job){if(Array.isArray(job)){for(var i in job){job[i].no_auto_update=true;processObject(job[i],log,ctrl)}}else{job.no_auto_update=true;processObject(job,log,ctrl)}}}function processObject(res,log,ctrl){if(res.message&&log){if(Array.isArray(res.message)){for(let i in res.message)log=addToLog(log,res.message[i])}else log=addToLog(log,res.message)}if(res.alert_begin){if(Array.isArray(res.alert_begin))for(var i=0;i<res.alert_begin.length;i++)window.alert(res.alert_begin[i]);else window.alert(res.alert_begin)}if(res.name&&res.uri&&res.uri!="-"){if(log&&dcLib_AjaxURI[res.name]!=res.uri)addToLog(log,"NEW URI("+res.name+"): "+res.uri);dcLib_AjaxURI[res.name]=res.uri}if(res.config)for(var vname in res.config)dcLib_Config[vname]=res.config[vname];if(res.remove)forEachSelector(res.remove,removeElement);if(res.remove_all)forEachSelector(res.remove_all,removeAllChildren);if(res.remove_begin)for(var sel in res.remove_begin)forEachSelector(sel,function(e,a){removeFirstChildren(e,a)},res.remove_begin[sel]);if(res.remove_end)for(var sel in res.remove_end)forEachSelector(sel,function(e,a){removeLastChildren(e,a)},res.remove_end[sel]);if(res.remove_until_id)for(var sel in res.remove_until_id)forEachSelector(sel,function(e,a){removeChildrenUntilId(e,a)},res.remove_until_id[sel]);if(res.remove_until_id_inc)for(var sel in res.remove_until_id_inc)forEachSelector(sel,function(e,a){removeChildrenUntilIdInc(e,a)},res.remove_until_id_inc[sel]);if(res.remove_from_id)for(var sel in res.remove_from_id)forEachSelector(sel,function(e,a){removeChildrenFromId(e,a)},res.remove_from_id[sel]);if(res.remove_until_class)for(var sel in res.remove_until_class)forEachSelector(sel,function(e,a){removeChildrenUntilClass(e,a)},res.remove_until_class[sel]);if(res.remove_until_class_inc)for(var sel in res.remove_until_class_inc)forEachSelector(sel,function(e,a){removeChildrenUntilClassInc(e,a)},res.remove_until_class_inc[sel]);if(res.remove_from_class)for(var sel in res.remove_from_class)forEachSelector(sel,function(e,a){removeChildrenFromClass(e,a)},res.remove_from_class[sel]);if(res.hide)forEachSelector(res.hide,hideElement);if(res.clear)forEachSelector(res.clear,clearElement);if(res.replace)for(var sel in res.replace)forEachSelector(sel,function(e,a){e.innerHTML=a},res.replace[sel]);if(res.replace_value)for(var sel in res.replace_value)forEachSelector(sel,function(e,a){e.value=a},res.replace_value[sel]);if(res.insert)for(var sel in res.insert)forEachSelector(sel,function(e,a){e.innerHTML=a+e.innerHTML},res.insert[sel]);if(res.insert_tr)for(var sel in res.insert_tr)if(Array.isArray(res.insert_tr[sel])){var list=res.insert_tr[sel];list.reverse();for(var i in list)forEachSelector(sel,function(e,a){var tr=createElementByDef("tr",a);e.insertBefore(tr,e.childNodes[0])},list[i])}else forEachSelector(sel,function(e,a){var tr=createElementByDef("tr",a);e.insertBefore(tr,e.childNodes[0])},res.insert_tr[sel]);if(res.append)for(var sel in res.append)forEachSelector(sel,function(e,a){e.innerHTML+=a},res.append[sel]);if(res.append_tr)for(var sel in res.append_tr)if(Array.isArray(res.append_tr[sel])){var list=res.append_tr[sel];for(var i in list)forEachSelector(sel,function(e,a){e.appendChild(createElementByDef("tr",a))},list[i])}else forEachSelector(sel,function(e,a){e.appendChild(createElementByDef("tr",a))},res.append_tr[sel]);editObjectResult(res);if(res.set_class)for(var sel in res.set_class)forEachSelector(sel,function(e,a){setClassElement(e,a)},res.set_class[sel]);if(res.remove_class)for(var sel in res.remove_class)forEachSelector(sel,function(e,a){removeClassElement(e,a)},res.remove_class[sel]);if(res.add_class)for(var sel in res.add_class)forEachSelector(sel,function(e,a){addClassElement(e,a)},res.add_class[sel]);if(res.colspan)for(var sel in res.colspan)forEachSelector(sel,function(e,a){e.colSpan=a},res.colspan[sel]);if(res.show)forEachSelector(res.show,showElement);if(res.display)for(var sel in res.display)forEachSelector(sel,function(e,a){e.style.display=a},res.display[sel]);if(res.hide2)forEachSelector(res.hide2,hideElement);if(res.invisible)forEachSelector(res.invisible,invisibleElement);if(res.visible)forEachSelector(res.visible,visibleElement);if(res.invisible2)forEachSelector(res.invisible2,invisibleElement);if(res.disable)forEachSelector(res.disable,disableElement);if(res.enable)forEachSelector(res.enable,enableElement);if(res.disable2)forEachSelector(res.disable2,disableElement);if(res.select_index)for(var sel in res.select_index)forEachSelector(sel,function(e,a){e.selectedIndex=a},res.select_index[sel]);if(res.autofocus)setFocus(res.autofocus,true,log);if(res.clipboard)setClipboardText(res.clipboard);if(res.local_tooltip_alias)for(var alias in res.local_tooltip_alias)dcLib_LocalTooltipAlias[alias]=res.local_tooltip_alias[alias];if(res.local_tooltip!==undefined)registerLocalTooltips(res.local_tooltip);else if(dcLib_LocalTooltipSelector)registerLocalTooltips(dcLib_LocalTooltipSelector);if(Array.isArray(res.replace_state)){let rs=res.replace_state;if(rs.length>=3)history.replaceState(rs[0],rs[1],rs[2]);else if(rs.length>=2)history.replaceState(rs[0],rs[1]);else if(rs.length>=1)history.replaceState(rs[0],"")}else if(res.push_state)history.replaceState(res.replace_state,"");if(Array.isArray(res.push_state)){let ps=res.push_state;if(ps.length>=3)history.pushState(ps[0],ps[1],ps[2]);else if(ps.length>=2)history.pushState(ps[0],ps[1]);else if(ps.length>=1)history.pushState(ps[0],"")}else if(res.push_state)history.pushState(res.push_state,"");if(res.location)window.location.assign(res.location);if(res.location_hash)window.location.hash=res.location_hash;if(res.open_window){if(Array.isArray(res.open_window))for(var i=0;i<res.open_window.length;i++)openWindow(res.open_window[i]);else openWindow(res.open_window)}if(res.modal){if(Array.isArray(res.modal))for(var i=0;i<res.modal.length;i++)new dcLibModal(res.modal[i]);else new dcLibModal(res.modal)}if(res.func){if(Array.isArray(res.func))for(var i=0;i<res.func.length;i++)eval(res.func[i]+"(log,ctrl,res)");else eval(res.func+"(log,ctrl,res)")}if(res.func_delay){if(Array.isArray(res.func_delay))for(var i=0;i<res.func.length;i++){var p=res.func_delay[i].split(",");if(p.length>=2)eval("setTimeout(function(){"+p[1]+"(log,ctrl,res)},p[0])")}else{var p=res.func_delay.split(",");if(p.length>=2)eval("setTimeout(function(){"+p[1]+"(log,ctrl,res)},p[0])")}}if(res.eval){if(Array.isArray(res.eval))for(var i=0;i<res.eval.length;i++)eval(res.eval[i]);else eval(res.eval)}if(res.job)processJob(res.job,log,ctrl);if(!res.no_auto_update)ExecuteAutoUpdate();if(res.alert_end){if(Array.isArray(res.alert_end))for(var i=0;i<res.alert_end.length;i++)window.alert(res.alert_end[i]);else window.alert(res.alert_end)}if(res.request_query){var new_ctrl={name:ctrl.name,seq_name:ctrl.seq_name,query:res.request_query,func:ctrl.func,log:log};requestAjaxObject(new_ctrl)}}function processAjaxObject(ctrl,req){var now=performance.now();if(!req||req.readyState!=4||req.status!=200||!req.responseText)return;var res=JSON.parse(req.responseText);if(res){var ignore=res.seq&&ctrl.seq_name&&dcLib_AjaxSeq[ctrl.seq_name]&&dcLib_AjaxSeq[ctrl.seq_name]!=res.seq&&!res.force;if(res.log_console)console.log("responseText=",req.responseText);var log;if(res.log)log=res.log;else if(ctrl.log)log=ctrl.log;if(log){var msg="RECEIVED";if(res.seq)msg+="[seq="+res.seq+"]";msg+=": "+req.responseText.length+" bytes";if(ctrl.tim){var ms=now-ctrl.tim;msg+=" after "+ms+" ms"}if(res.log_msg)msg+=": "+res.log_msg;addToLog(log,msg);if(res.log_json){var s=new String(req.responseText);addToLog(log,s.replace(/\&/g,"&amp;").replace(/\</g,"&lt;"))}now=performance.now()}if(ignore){if(log)addToLog(log,"â–² IGNORED!");return}processObject(res,log,ctrl);if(ctrl.func)ctrl.func(log,ctrl,res);if(log)addToLog(log,"â–² PROCESSED in "+(performance.now()-now)+" ms")}else console.log("Invalid JSON: "+req.responseText)}function cancelAjaxObject(ctrl){if(typeof ctrl==="string"){console.log("cancelAjaxObject("+ctrl+")");dcLib_AjaxSeq[ctrl]=-1;console.log(dcLib_AjaxSeq)}else{if(ctrl.seq_name)dcLib_AjaxSeq[ctrl.seq_name]=-1;if(ctrl.delay_name&&dcLib_AjaxDelay[ctrl.delay_name]){clearTimeout(dcLib_AjaxDelay[ctrl.delay_name]);delete dcLib_AjaxDelay[ctrl.delay_name]}}}function requestAjaxObject(ctrl){cancelAjaxObject(ctrl);if(ctrl.delay_name){if(ctrl.delay&&ctrl.delay>0){var delay=ctrl.delay;delete ctrl.delay;if(ctrl.log)ctrl.log=addToLog(ctrl.log,"âˆž DELAY "+delay+" ms");dcLib_AjaxDelay[ctrl.delay_name]=setTimeout(function(){requestAjaxObject(ctrl)},delay);return}}let uri=ctrl.uri||dcLib_AjaxURI[ctrl.name];if(uri){if(ctrl.seq_name){if(ctrl.seq_name==1)ctrl.seq_name=ctrl.name;var seq=++dcLib_AjaxSeqNum;dcLib_AjaxSeq[ctrl.seq_name]=seq;uri+="&seq="+seq}if(ctrl.query)uri+=ctrl.query;let use_post=dcLib_AjaxUsePost[ctrl.name]||dcLib_AjaxUsePostDef;ctrl.log=ctrl.log?addToLog(ctrl.log,"â–¼ "+(use_post?"POST":"GET")+"("+ctrl.name+"): "+uri):undefined;var req=new XMLHttpRequest;ctrl.tim=performance.now();req.onreadystatechange=function(){processAjaxObject(ctrl,this)};if(use_post||ctrl.formdata){let param,pos=uri.indexOf("?");if(pos>=0){param=uri.substring(pos+1);uri=uri.substring(0,pos)}req.open("POST",uri,true);if(ctrl.formdata){console.log("use formdata");let list=param.split("&");for(var i=0;i<list.length;i++){let par=list[i];let pos=par.indexOf("=");if(pos<0)ctrl.formdata.append(par,"");else ctrl.formdata.append(par.substring(0,pos),decodeURIComponent(par.substring(pos+1)))}req.send(ctrl.formdata)}else{req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");req.send(param)}}else{req.open("GET",uri,true);req.send()}}else{addToLog(ctrl.log,"CAN'T SEND("+ctrl.name+"): "+ctrl.query);console.log(ctrl)}}function processAjaxObjectP(log,req,seq_name,tim,func){let ctrl={log:log,seq_name:seq_name,tim:tim,func:func};processAjaxObject(ctrl,req)}function requestAjaxObjectP(name,query,seq_name,log,func,client){let ctrl={name:name,query:query,seq_name:seq_name,log:log,func:func,client:client};requestAjaxObject(ctrl)}function requestAjaxObjectSelect(id,name,query,qname,seq_name,log,func){let e=getElementByIdIfString(id);if(e){query+="&"+qname+"="+encodeURIComponent(e.options[e.selectedIndex].value);var ctrl={name:name,query:query,seq_name:seq_name,log:log,func:func};requestAjaxObject(ctrl)}}function createTooltipCtrl(name,delay){return{name:name,log:name+"-log",seq_name:name,delay_name:name,delay:delay===undefined?dcLib_TooltipDelay:delay}}function viewTooltip(name,id,ref,delay){var e=document.getElementById(id);if(e){hideElement(e);e.innerHTML="?";var ctrl=createTooltipCtrl(name,delay);ctrl.query="&j=tooltip"+"&id="+id+"&ref="+ref;requestAjaxObject(ctrl)}}function cancelTooltip(name,id){var ctrl=createTooltipCtrl(name);cancelAjaxObject(ctrl);var e=document.getElementById(id);if(e)hideElement(id)}function sendAjaxJob(query,log){var ctrl={log:log,name:"-",query:query};if(dcLib_DEVELOP)console.log(ctrl);requestAjaxObject(ctrl)}function hideCookieWarning(ev){if(ev.target){sendAjaxJob("&j=cookie&m=1&id="+ev.target.id);ev.target.style.display="none";forEachClass("cookie-warning",hideElement);forEachClass("cookie-accept",hideElement)}}function acceptPrivacy(ev){if(ev.target){sendAjaxJob("&j=cookie&m=2&id="+ev.target.id);ev.target.style.display="none";forEachClass("cookie-warning",hideElement);forEachClass("cookie-accept",hideElement);forEachClass("privacy-accept",hideElement)}}var dcLib_ModalName="@update";var dcLib_ModalList=[];function enlargeTable(name){if(!dcLib_AjaxURI[name])return;var log=document.getElementById(name+"-log");var req=new XMLHttpRequest;req.onreadystatechange=function(){if(this.readyState!=4||this.status!=200)return;var res=JSON.parse(this.responseText);if(!res)return;dcLib_AjaxURI[name]=res.uri;var e=document.getElementById(name+"-title");if(e)e.innerHTML=res.title;e=document.getElementById(name+"-button");if(e){e.innerHTML=res.button;if(res.is_last)e.style.display="none"}e=document.getElementById(name+"-table");if(e){if(res.insert_top)e.tBodies[0].innerHTML=res.html+e.tBodies[0].innerHTML;else e.tBodies[0].innerHTML+=res.html}editObjectResult(res);if(res.func){if(Array.isArray(res.func))for(var i=0;i<res.func.length;i++)eval(res.func[i]+"(log,res)");else eval(res.func+"(log,res)")}addToLog(log,"â–² RECEIVED: "+res.uri)};addToLog(name+"-log","â–¼ SEND: "+dcLib_AjaxURI[name]);req.open("GET",dcLib_AjaxURI[name],true);req.send()}function editObjectInit(list){if(list===undefined)list=dcLib_EditObj;var add=list!==dcLib_EditObj;if(dcLib_DEVELOP)console.log("editObjectInit(N="+Object.keys(list).length+") add="+add);for(var key in list){var obj=list[key];var e=document.getElementById(obj.id);if(e){if(obj.g&&dcLib_EditGroup[obj.g])for(var nam in dcLib_EditGroup[obj.g])if(obj[nam]===undefined)obj[nam]=dcLib_EditGroup[obj.g][nam];if(add)dcLib_EditObj[obj.id]=obj;e.tabIndex=0;e.style.cursor="pointer";e.addEventListener("click",editObjectClick);e.addEventListener("keydown",editObjectKey);forEachClass(obj.id,function(e2){e2.redir=obj.id;e2.x_display=e2.style.display;e2.style.cursor="pointer";e2.addEventListener("click",editObjectClick)})}}}function editObjectResult(res){if(res.editobj_set||res.editobj_add||res.editobj_init){if(res.editobj_set)dcLib_EditObj=res.editobj_set;if(res.editobj_add)for(var key in res.editobj_add){var obj=res.editobj_add[key];dcLib_EditObj[obj.id]=obj}editObjectInit()}}function editObjectClick(ev){var obj=editObjectGet(this);if(!obj||ev.target.nodeName=="A")return;if(dcLib_EditObj[dcLib_ActiveEdit]&&dcLib_ActiveEdit!=obj.id){var obj2=dcLib_EditObj[dcLib_ActiveEdit];var cancel=true;switch(obj2.type){case"text":cancel=editObjectCancelText(ev,obj2);break;case"select":cancel=editObjectCancelSelect(ev,obj2);break}if(!cancel)return;editObjectReset(document.getElementById(obj2.id));dcLib_ActiveEdit=undefined}if(!obj.edit)switch(obj.type){case"keytest":return editObjectClickKeytest(ev,obj);case"postest":return editObjectClickPostest(ev,obj);case"text":return editObjectClickText(ev,obj);case"select":return editObjectClickSelect(ev,obj)}}function editObjectKey(ev){var obj=editObjectGet(this);if(!obj)return;if(!obj.edit){var stat=false;switch(obj.type){case"text":stat=editObjectKeyText(ev,obj);case"select":stat=editObjectKeySelect(ev,obj)}if(!stat){switch(ev.keyCode){case 37:case 38:var obj=editObjectGet(document.activeElement);if(obj){var jump=ev.ctrlKey||ev.shiftKey||ev.keyCode==37;var prev=undefined;for(var key in dcLib_EditObj)if(key==obj.id){if(prev)setFocus(dcLib_EditObj[prev].id);break}else if(jump||dcLib_EditObj[key].eo==obj.eo)prev=key}ev.stopPropagation();ev.preventDefault();break;case 39:case 40:var obj=editObjectGet(document.activeElement);if(obj){var jump=ev.ctrlKey||ev.shiftKey||ev.keyCode==39;var next=false;for(var key in dcLib_EditObj)if(key==obj.id)next=true;else if(next&&(jump||dcLib_EditObj[key].eo==obj.eo)){setFocus(dcLib_EditObj[key].id);break}}ev.stopPropagation();ev.preventDefault();break}}}else{switch(ev.keyCode){case 120:console.log("BINGO 120");if(obj.div)moveElementInto(obj.div,getViewPort());ev.stopPropagation();ev.preventDefault();break}}}function editObjectGet(e){if(e&&dcLib_EditObj[e.id])return dcLib_EditObj[e.id];if(e.redir&&dcLib_EditObj[e.redir])return dcLib_EditObj[e.redir];return undefined}function editObjectStart(e){if(!e||!dcLib_EditObj[e.id])return false;var obj=dcLib_EditObj[e.id];if(obj.edit)return false;addToLog(obj.eo+"-log","EDIT "+obj.id);obj.edit=true;obj.orig=e.innerHTML;if(obj.val===undefined&&!obj.pw)obj.val=obj.orig;dcLib_ActiveEdit=obj.id;disableLocalTooltip("editObject");if(dcLib_DEVELOP)console.log(obj);if(obj.ccls){obj.div=document.createElement("div");obj.div.classList.add(obj.ccls);obj.div.classList.add("editobj-start");e.appendChild(obj.div);var style=window.getComputedStyle(obj.div);console.log("pos/style: lt="+style.left+" top="+style.top);return obj.div}delete obj.div;forEachClass(obj.id,hideElement);return e}function editObjectReset(e,val){if(e){var obj=dcLib_EditObj[e.id];if(obj&&obj.edit){addToLog(obj.eo+"-log","RESET "+obj.id+": "+val);enableLocalTooltip("editObject");if(obj.div){if(obj.div.parentNode==e)e.removeChild(obj.div);delete obj.div}else forEachClass(obj.id,showElement);dcLib_ActiveEdit=undefined;obj.edit=0;e.disabled=false;e.innerHTML=val===undefined||obj.pw?obj.orig:val;e.style.cursor="pointer";e.tabIndex=0;setFocus(e)}}}function editObjectUpdate(log,ctrl,res){if(ctrl.elem){addToLog(log,"UPDATE "+ctrl.elem.id);ctrl.elem.classList.remove("editobj-wait");editObjectReset(ctrl.elem,res.val?res.val:undefined)}}function editObjectStore(e,val){if(e){var obj=dcLib_EditObj[e.id];if(obj&&obj.edit){if(dcLib_DEVELOP)console.log("editObjectStore("+val+")");if(obj.val==val)editObjectReset(e);else{addToLog(obj.eo+"-log","STORE "+obj.id);enableLocalTooltip("editObject");dcLib_ActiveEdit=undefined;if(obj.div){obj.div.classList.add("editobj-wait");obj.div.style.cursor="wait";obj.div.disabled=true}{e.innerHTML="?";e.classList.add("editobj-wait")}e.style.cursor="wait";e.disabled=true;if(obj.div)obj.div.disabled=true;var ctrl={name:obj.eo,query:"&j=store&id="+obj.id+"&type="+obj.type+"&obj="+obj.obj+"&idx="+obj.idx,func:editObjectUpdate,elem:e,log:obj.eo+"-log"};if(obj.post)ctrl.post_data=val;else ctrl.query+="&data="+encodeURIComponent(val);requestAjaxObject(ctrl)}}}}function editObjectSetWarn(obj){if(obj){obj.inp.classList.add("editobj-warn");if(obj.div){obj.div.classList.add("editobj-div-warn")}}}function editObjectClearWarn(obj){if(obj){obj.inp.classList.remove("editobj-warn");if(obj.div){obj.div.classList.remove("editobj-div-warn")}}}function editObjectWarn(obj,set){if(set)editObjectSetWarn(obj);else editObjectClearWarn(obj)}function editObjectVerified(log,ctrl,res){var e=ctrl.elem;addToLog(log,"VERIFIED "+e.id);var obj=dcLib_EditObj[e.id];if(obj&&obj.edit){if(res.val)obj.inp.value=res.val;editObjectWarn(obj,res.warn);var x=obj.div?obj.div:e;x.classList.remove("editobj-wait");x.disabled=false;x.style.cursor="pointer";obj.inp.select()}}function editObjectVerify(e,mode,val){if(e){var obj=dcLib_EditObj[e.id];if(obj&&obj.edit){addToLog(obj.eo+"-log","VERIFY="+mode+" "+obj.id);var x=obj.div?obj.div:e;x.classList.add("editobj-wait");x.style.cursor="wait";x.disabled=true;var ctrl={name:obj.eo,query:"&j=verify&id="+obj.id+"&mode="+mode+"&type="+obj.type+"&obj="+obj.obj+"&idx="+obj.idx,func:editObjectVerified,elem:e,log:obj.eo+"-log"};if(obj.post)ctrl.post_data=val;else ctrl.query+="&data="+encodeURIComponent(val);requestAjaxObject(ctrl)}}}function editObjectGetParent(e){if(e){e=e.parentNode;if(e&&e.id&&dcLib_EditObj[e.id])return e}if(e){e=e.parentNode;if(e&&e.id&&dcLib_EditObj[e.id])return e}return undefined}function editObjectClickKeytest(ev,obj){addToLog(obj.eo+"-log","KEYTEST "+obj.id);var e=document.getElementById(obj.id);if(e){var ed=editObjectStart(e);ed.innerHTML="?";setFocus(ed);ed.addEventListener("keydown",editObjectKeytestDown);ev.stopPropagation()}}function editObjectKeytestDown(ev){if(!this.id||!dcLib_EditObj[this.id])return;var obj=dcLib_EditObj[this.id];var e=document.getElementById(obj.id);if(e&&obj.edit){var msg="type="+ev.type+", charC="+ev.charCode+",  keyC="+ev.keyCode+",  repeat="+ev.repeat+",  ctrl="+ev.ctrlKey+",  shift="+ev.shiftKey+",  alt="+ev.altKey+",  meta="+ev.metaKey;addToLog(obj.eo+"-log","KEYTEST: "+msg);e.innerHTML=msg;setFocus(e);ev.stopPropagation();ev.preventDefault()}}function editObjectClickPostest(ev,obj){addToLog(obj.eo+"-log","POSTEST "+obj.id);var e=document.getElementById(obj.id);if(e){var msg="SIZE: "+"w.inner="+window.innerWidth+","+window.innerHeight+", d.client="+document.documentElement.clientWidth+","+document.documentElement.clientHeight+"<br>SCROLL:"+"d="+document.documentElement.scrollTop+","+document.documentElement.scrollLeft+" / "+document.documentElement.scrollWidth+","+document.documentElement.scrollHeight+"<br>getScrollPos() = "+JSON.stringify(getScrollPos())+"<br>getBoundingPos() = "+JSON.stringify(getBoundingPos())+"<p>getScrollPos(this) = "+JSON.stringify(getScrollPos(e))+"<br>getBoundingPos(this) = "+JSON.stringify(getBoundingPos(e));e.innerHTML=msg;ev.stopPropagation()}}function editObjectTextStart(ev,e,obj,val){var attrib=obj.pw?"type=password autocomplete=new-password":"type="+(obj.itype?obj.itype:"text");if(obj.min!==undefined)attrib+=' min="'+obj.min+'"';if(obj.max!==undefined)attrib+=' max="'+obj.max+'"';if(obj.step!==undefined)attrib+=' step="'+obj.step+'"';if(obj.maxlen)attrib+=" maxlength="+obj.maxlen;if(obj.placeholder)attrib+=' placeholder="'+obj.placeholder+'"';if(obj.pattern)attrib+=' pattern="'+obj.pattern+'"';if(obj.style)attrib+=' style="'+obj.style+'"';if(obj.alt)attrib+=' alt="'+obj.alt+'"';if(obj.title)attrib+=' title="'+obj.title+'"';if(obj.attrib)attrib+=" "+obj.attrib;if(dcLib_DEVELOP)console.log("attrib="+attrib);var text="<input "+attrib+">";if(obj.before)text=obj.before+text;if(obj.after)text+=obj.after;var ed=editObjectStart(e);ed.innerHTML=text;obj.inp=ed.querySelector("input");if(dcLib_DEVELOP)console.log(obj.inp);if(!obj.pw)obj.inp.value=val!==undefined?val:obj.val;setFocus(obj.inp,obj.inp.type=="text");obj.inp.addEventListener("blur",function f(event){editObjectCancelText(event,obj)});obj.inp.addEventListener("keydown",editObjectTextKey);obj.inp.addEventListener("input",editObjectTextInput);if(ev){ev.stopPropagation();ev.preventDefault()}}function editObjectCancelText(ev,obj){var e=document.getElementById(obj.id);if(e){if(xtrim(obj.inp.value)!=xtrim(obj.val)){setFocus(obj.inp);editObjectSetWarn(obj);return false}editObjectReset(e)}return true}function editObjectClickText(ev,obj){var e=document.getElementById(obj.id);if(e)editObjectTextStart(ev,e,obj)}function editObjectKeyText(ev,obj){var e=document.getElementById(obj.id);if(e){switch(ev.keyCode){case 13:editObjectTextStart(ev,e,obj);return true;case 8:case 46:editObjectTextStart(ev,e,obj,"");return true;case 36:editObjectTextStart(ev,e,obj);obj.inp.setSelectionRange(0,0);return true;case 35:editObjectTextStart(ev,e,obj);var pos=obj.inp.value.length;obj.inp.setSelectionRange(pos,pos);return true}}return false}function editObjectTextKey(ev){var e=editObjectGetParent(this);if(!e)return;var obj=dcLib_EditObj[e.id];if(obj.edit){obj.inp.classList.remove("editobj-warn");if(obj.div){obj.div.classList.remove("editobj-start");obj.div.classList.remove("editobj-div-warn")}if(ev.keyCode==27){editObjectReset(e);ev.stopPropagation();ev.preventDefault()}else if(ev.keyCode==13){if(!this.value.length&&obj.pw)editObjectReset(e);else{var val_ok=true;if(obj.minlen&&this.value.length<obj.minlen)val_ok=false;if(obj.maxlen&&this.value.length>obj.maxlen)val_ok=false;if(val_ok&&obj.pattern&&obj.pattern.length){var re=new RegExp(obj.pattern);val_ok=re.test(this.value)}if(val_ok||this.value=="-"&&obj.pw&8)editObjectStore(e,this.value);else{obj.inp.classList.add("editobj-warn");if(obj.div)obj.div.classList.add("editobj-div-warn")}}ev.stopPropagation();ev.preventDefault()}else if(ev.keyCode==71&&ev.ctrlKey&&obj.pw&&obj.pw&4){obj.inp.type="text";obj.inp.value="";editObjectVerify(e,"genpw");ev.stopPropagation();ev.preventDefault()}else if(ev.keyCode==83&&ev.ctrlKey&&obj.pw&&obj.pw&2){obj.inp.type=obj.inp.type=="text"?"password":"text";ev.stopPropagation();ev.preventDefault()}}}function editObjectTextInput(ev){if(!this.parentNode.id||!dcLib_EditObj[this.parentNode.id])return;var e=this.parentNode;var obj=dcLib_EditObj[e.id];if(obj.edit){this.classList.remove("editobj-warn");if(obj.div)obj.div.classList.remove("editobj-div-warn");if(obj.val===this.value)this.classList.remove("editobj-modified");else this.classList.add("editobj-modified")}}function editObjectSelectStart(ev,e,obj,val){if(!obj.sel||!dcLib_EditSelect[obj.sel])return false;var sel=dcLib_EditSelect[obj.sel];var text=obj.before?obj.before:"";text+="<select>";var ch=sel.ch?' class="'+sel.ch+'"':"";var cv=sel.cv?' class="'+sel.cv+'"':"";var head="";var n_opt=0;for(var i=0;i<sel.list.length;i++){var opt=sel.list[i];if(opt.text){if(opt.value===undefined)head="<option"+ch+" disabled>"+opt.text+"</option>";else{text+=head+"<option"+cv+' value="'+opt.value+'"';if(obj.val==opt.value)text+=" selected";text+=">"+opt.text+"</option>";n_opt++;if(head){n_opt++;head=""}}}}text+="</select>";if(obj.after)text+=obj.after;var ed=editObjectStart(e);ed.innerHTML=text;obj.select=ed.querySelector("select");obj.select.size=n_opt>18?15:n_opt;setFocus(obj.select);obj.select.addEventListener("blur",function f(event){editObjectCancelSelect(event,obj)});obj.select.addEventListener("keydown",editObjectSelectKey);obj.select.addEventListener("click",editObjectSelectInput);if(ev){ev.stopPropagation();ev.preventDefault()}}function editObjectCancelSelect(ev,obj){var e=document.getElementById(obj.id);if(e){var val=obj.select.options[obj.select.selectedIndex].value;if(val!==undefined&&val!=obj.val){setFocus(obj.select);obj.select.classList.add("editobj-warn");return false}editObjectReset(e)}return true}function editObjectClickSelect(ev,obj){var e=document.getElementById(obj.id);if(e)editObjectSelectStart(ev,e,obj,obj.orig)}function editObjectKeySelect(ev,obj){var e=document.getElementById(obj.id);if(e){switch(ev.keyCode){case 13:editObjectSelectStart(ev,e,obj);return true}}return false}function editObjectSelectKey(ev){var e=editObjectGetParent(this);if(!e)return;var obj=dcLib_EditObj[e.id];if(obj.edit){obj.select.classList.remove("editobj-warn");if(ev.keyCode==27){editObjectReset(e);ev.stopPropagation();ev.preventDefault()}else if(ev.keyCode==13){var val=obj.select.options[obj.select.selectedIndex].value;console.log("editObjectSelectKey() RETURN "+obj.idx+"="+val+" ["+obj.val+"]");if(val!==undefined)editObjectStore(e,val);ev.stopPropagation();ev.preventDefault()}}}function editObjectSelectInput(ev){var e=editObjectGetParent(this);if(!e)return;var obj=dcLib_EditObj[e.id];if(obj.edit){var val=obj.select.options[obj.select.selectedIndex].value;console.log("editObjectSelectInput() CLICK "+obj.idx+"="+val);if(val!==undefined)editObjectStore(e,val);ev.stopPropagation();ev.preventDefault()}}function selectBoxInit(sbox,cls){if(sbox.cls_pre===undefined)sbox.cls_pre="";if(sbox.job===undefined)sbox.job="setstate";if(sbox.m_id===undefined)sbox.m_id="data-id";if(sbox.f_click===undefined)sbox.f_click=selectBoxActivateByClick;if(sbox.f_key===undefined)sbox.f_key=selectBoxActivateByKey;var count=0;if(cls)forEachClass(cls,function(e){count++;if(sbox.f_click)e.addEventListener("click",function(ev){sbox.f_click(ev,sbox,e)});if(sbox.f_key)e.addEventListener("keydown",function(ev){sbox.f_key(ev,sbox,e)})});sbox.log=addToLog(sbox.log,"selectBoxInit("+cls+") N="+count)}function selectBoxFind(sbox,val){for(var i=0;i<sbox.opt.length;i++)if(sbox.opt[i].val==val)return sbox.opt[i];return undefined}function selectBoxActivate(sbox,e,id,start){if(e.classList.contains("dclib-edit-active"))return;if(id===undefined&&sbox.m_id)id=e.getAttribute(sbox.m_id);addToLog(sbox.log,"selectBoxActivate("+id+") class="+e.className);e.orig="__invalid__";var opt="";for(var i=0;i<sbox.opt.length;i++){var s=sbox.opt[i];opt+="<option value="+s.val+' title="'+s.info+'"';if(e.classList.contains(sbox.cls_pre+s.cls)){e.classList.remove(sbox.cls_pre+s.cls);e.orig=s.val;if(!start)opt+=" selected"}opt+=">"+s.edit+"</option>"}e.classList.add("dclib-edit-active");e.title="";e.style.cursor="auto";e.innerHTML="<select>"+opt+"</select>\n";var sel=e.querySelector("select");sel.size=sbox.opt.length;setFocus(sel);var edit={sbox:sbox,elem:e,id:id,sel:sel};sel.addEventListener("blur",function(ev){selectBoxOnChange(ev,edit)});sel.addEventListener("click",function(ev){selectBoxOnChange(ev,edit)});sel.addEventListener("keydown",function(ev){selectBoxOnKey(ev,edit)})}function selectBoxActivateByClick(ev,sbox,e,id,start){selectBoxActivate(sbox,e,id,start)}function selectBoxActivateByKey(ev,sbox,e,id){if(e.classList.contains("dclib-edit-active"))return;if(id===undefined&&sbox.m_id)id=e.getAttribute(sbox.m_id);addToLog(sbox.log,"selectBoxActivateByKey("+id+") key="+ev.key);if(ev.key=="Enter"||ev.key=="Up"||ev.key=="Down"||ev.key=="ArrowUp"||ev.key=="ArrowDown"){selectBoxActivate(sbox,e,id);ev.stopPropagation()}else if(ev.key>="a"&&ev.key<="z"||ev.key>="0"&&ev.key<="9"){var start=0;for(var i=0;i<sbox.opt.length;i++){var s=sbox.opt[0];var c=s.edit.substring(0,1).toLowerCase();if(ev.key==c){start=1;break}}selectBoxActivate(sbox,e,id,start);ev.stopPropagation()}}function selectBoxOnChange(ev,edit){var val=edit.sel.options[edit.sel.selectedIndex].value;addToLog(edit.sbox.log,"selectBoxOnChange("+edit.id+") value="+val);var e=edit.elem;if(e.orig&&e.orig==val)selectBoxUpdate(edit.sbox.log,{x_edit:edit},{x_val:val});else{e.innerHTML="?";e.style.cursor="wait";e.disabled=true;var ctrl={x_edit:edit,name:edit.sbox.name,query:"&j="+edit.sbox.job+"&id="+edit.id+"&val="+val,log:edit.sbox.log,func:selectBoxUpdate};requestAjaxObject(ctrl)}ev.stopPropagation()}function selectBoxOnKey(ev,edit){addToLog(edit.sbox.log,"selectBoxOnKey("+edit.id+") key="+ev.key+", orig="+edit.elem.orig);if(ev.key=="Enter")selectBoxOnChange(ev,edit);else if(ev.key=="Escape"||ev.key=="Esc"){selectBoxUpdate(edit.sbox.log,{x_edit:edit},{x_val:edit.elem.orig});ev.stopPropagation()}}function selectBoxUpdate(log,ctrl,res){let edit=ctrl.x_edit;addToLog(log,"selectBoxUpdate("+edit.id+":="+res.x_val+")");let e=edit.elem;let s=selectBoxFind(edit.sbox,res.x_val);if(e&&s){e.classList.remove("dclib-edit-active");e.classList.add(edit.sbox.cls_pre+s.cls);e.title=s.info;e.innerHTML=s.text;e.style.cursor="pointer";e.disabled=false;e.orig=s.val;setFocus(e)}}function dcLibPredict(name,idx,mode){let obj=this;let prefix=name+"_"+idx;this.name=name;this.log=addToLog0(name+"-log");this.query="&idx="+idx;if(mode)this.query+="&mode="+encodeURIComponent(mode);this.input=document.getElementById(prefix+"-input");this.list=document.getElementById(prefix+"-list");this.result=document.getElementById(prefix+"-result");this.info=document.getElementById(prefix+"-info");this.debug=document.getElementById(prefix+"-debug");this.request_active=false;this.index=0;this.total=0;this.predict=true;this.last_predict="";this.orig=null;this.current={id:null,val:null,info:null};this.save={id:null,val:null,info:null};this.valid={id:null,val:null,info:null};if(this.info)this.current.info=this.info.innerHTML;if(dcLib_DEVELOP)console.log("dcLibPredict("+name+")");if(!this.input||!this.list)return;setupEventActivate();this.ISVALID_NO=0;this.ISVALID_NEW=1;this.ISVALID_EMPTY=2;this.ISVALID_MINUS=3;this.ISVALID_ORIG=4;this.ISVALID_FOUND=5;this.ISVALID_CURRENT=6;let opt=this.input.dataset.options||"";this.multi_word=opt.indexOf("W")>=0;this.allow_empty=opt.indexOf("E")>=0;this.allow_minus=opt.indexOf("M")>=0;this.allow_orig=opt.indexOf("O")>=0;this.allow_new=opt.indexOf("N")>=0;this.auto_focus=opt.indexOf("F")>=0;this.auto_submit=opt.indexOf("S")>=0;this.to_upper=opt.indexOf("U")>=0;this.to_lower=opt.indexOf("L")>=0;this.is_list=opt.indexOf("+")>=0;this.add_key=false;this.add_button=false;if(opt.indexOf("A")>=0){let arg=this.input.dataset.add.split(",");this.add_key=arg[0];let id=arg[1]||name+"-add";this.add_button=document.getElementById(id);if(this.add_button){this.add_button.addEventListener("click",function(ev){obj.onNewRecord(ev)});hideElement(this.add_button);visibleElement(this.add_button)}}this.func=this.input.dataset.func?JSON.parse(this.input.dataset.func):null;if(!this.func)this.func={};if(!this.func.begin)this.func.begin=null;if(!this.func.end)this.func.end=null;if(!this.func.select)this.func.select=null;if(!this.func.arg)this.func.arg=null;if(dcLib_DEVELOP)console.log("FUNC",this.func);let inp=this.input;inp.addEventListener("dc_entertarget",function(ev){obj.onEnterTarget(ev)});inp.addEventListener("dc_leavetarget",function(ev){obj.onLeaveTarget(ev)});inp.addEventListener("input",function(ev){obj.onChange(ev)});inp.addEventListener("keydown",function(ev){obj.onKey(ev)});if(this.multi_word){inp.addEventListener("click",function(ev){obj.onChange(ev,true)});inp.addEventListener("keyup",function(ev){obj.onChange(ev)})}if(dcLib_DEVELOP&&0){}this.setCurrent(this.current);if(dcLib_DEVELOP)console.log(this)}dcLibPredict.prototype.onEvent=function(ev){addToLog(this.log,"â˜Ž dcLibPredict::onEvent("+this.name+") event="+ev.type);console.log(ev)};dcLibPredict.prototype.onEnterTarget=function(ev){this.orig=getInputData(this.input);addToLog(this.log,"â˜Ž dcLibPredict::onEnterTarget("+this.name+") orig="+JSON.stringify(this.orig,null,1));if(this.add_button)hideElement(this.add_button);if(this.func.begin)execFunctionByName(window,this.func.begin,this,0,this.func.arg);return this.onChange(ev)};dcLibPredict.prototype.onLeaveTarget=function(ev){addToLog(this.log,"â˜Ž dcLibPredict::onLeaveTarget("+this.name+")");console.log(ev.detail.newtarget,this.add_button,this.valid);if(ev.detail.newtarget===this.add_button){addToLog(this.log," - preventActivation() on add_button");preventActivation(ev,null,this.log)}else if(this.isValid()){hideElement(this.list);if(this.add_button)hideElement(this.add_button);if(this.func.end)execFunctionByName(window,this.func.end,this,1,this.func.arg)}else if(!dcLib_ModalList.length)this.select(ev,0,true)};dcLibPredict.prototype.clearCurrent=function(noselect){this.setCurrent({id:null,val:null,info:null},noselect)};dcLibPredict.prototype.setCurrent=function(obj,noselect){if(obj.id==undefined||obj.id==null)obj.id="";this.current=obj;if(this.result)setValueOrInner(this.result,obj.id);if(this.info)setValueOrInner(this.info,obj.info||"Â ");if(this.debug){let msg="Ï´ "+obj.id;if(obj.info)msg+=", "+obj.info;setValueOrInner(this.debug,msg)}if(!noselect&&this.func.select)execFunctionByName(window,this.func.select,this,obj,this.func.arg)};dcLibPredict.prototype.setValid=function(id,val,info){this.valid.id=id;this.valid.val=val.trim();this.valid.info=info;if(!this.multiword&&this.valid.val==this.getCurrentWord())this.setCurrent(this.valid)};dcLibPredict.prototype.isValid=function(){let val=this.getCurrentWord();if(val==this.valid.val)this.setCurrent(this.valid);if(this.current.id!=="")return this.ISVALID_CURRENT;let ul=this.list.querySelector("ul");if(ul){for(let i=0;i<ul.childNodes.length;i++){let e=ul.childNodes[i];if(e&&e.dataset.value&&e.dataset.value.trim()===val){if(!this.multi_word){if(val!=e.dataset.value)this.input.value=e.dataset.value;this.setValid(e.dataset.id,e.dataset.value,e.dataset.info)}return this.ISVALID_FOUND}}}if(this.allow_orig&&val===this.orig.value)return this.ISVALID_ORIG;if(this.allow_minus&&(val=="-"||val=="âˆ’")){if(!this.multi_word)this.input.value="-";return this.ISVALID_MINUS}if(this.allow_empty&&val=="")return this.ISVALID_EMPTY;return this.allow_new?this.ISVALID_NEW:this.ISVALID_NO};dcLibPredict.prototype.getCurrentWord=function(){if(this.to_upper||this.to_lower){let data=getInputData(this.input);data.value=this.to_upper?data.value.toUpperCase():data.value.toLowerCase();if(this.input.value!==data.value)setInputData(this.input,data)}if(this.multi_word){let word=getCurrentWord(this.input.value,this.input.selectionStart);return word.word}return this.input.value.trim()};dcLibPredict.prototype.replaceCurrentWord=function(replace,verify){if(this.multi_word){let word=getCurrentWord(this.input.value,this.input.selectionStart);if(verify===undefined||verify.trim()==word.word){this.input.value=this.input.value.substring(0,word.from)+replace+this.input.value.substring(word.to);let pos=word.from+replace.length;this.input.setSelectionRange(pos,pos)}}else if(verify===undefined||verify.trim()==this.input.value.trim())this.input.value=replace};dcLibPredict.prototype.onChange=function(ev,force_predict){if(this.input.value.trim()!==this.valid.val)this.clearCurrent(true);if(force_predict)this.predict=true;let value=this.getCurrentWord();if(force_predict||this.last_predict!==value){addToLog(this.log,"â˜Ž dcLibPredict::onChange()");this.last_predict=value;if(this.add_button)hideElement(this.add_button);if(value==""){cancelAjaxObject(this.name);this.list.innerHTML="";hideElement(this.list)}else if(this.predict){this.request_active=true;let query=this.query+"&text="+encodeURIComponent(value);let obj=this;requestAjaxObjectP(this.name,query,this.name,this.log,function(log,recv,res){obj.onReceive(log,recv,res)})}this.onChangedText()}};dcLibPredict.prototype.onChangedText=function(){this.input.classList.remove("fail");if(this.is_list)this.clearCurrent();let valid=this.isValid();if(this.add_button){if(valid||this.request_active||this.getCurrentWord()=="")hideElement(this.add_button);else showElement(this.add_button)}if(valid>this.ISVALID_EMPTY)this.input.classList.add("is-ok");else this.input.classList.remove("is-ok")};dcLibPredict.prototype.select=function(ev,index,final){index=index%(this.total+1);let allow_final=final&&(!this.multi_word||!index&&!this.index);addToLog(this.log,"index: "+this.index+" -> "+index+", final="+final+", allow_final="+allow_final);if(index!=this.index){let ul=this.list.querySelector("ul");if(ul){if(this.index){let e=ul.childNodes[this.index-1];if(e)e.classList.remove("select")}if(index>0){let e=ul.childNodes[index-1];if(e){e.classList.add("select");if(this.multi_word){setInputData(this.input,this.save.val);this.replaceCurrentWord(e.dataset.value)}else{if(e.dataset.value==this.save.val)setInputData(this.input,this.save.val);else this.input.value=e.dataset.value;this.setValid(e.dataset.id,e.dataset.value,e.dataset.info);if(final&&!this.multi_word)this.save=this.current}}this.index=index}else{this.index=0;this.setCurrent(this.save);setInputData(this.input,this.save.val)}}this.onChangedText()}this.predict=false;let valid=this.isValid();if(final&&!allow_final&&this.input.value.length===this.input.selectionStart){this.input.value=this.input.value.trim()+" ";hideElement(this.list)}let status=true;if(allow_final){if(valid){hideElement(this.list);if(this.func.end)execFunctionByName(window,this.func.end,this,1,this.func.arg);if(this.auto_submit){console.log({0:"auto_submit"},this.input);this.input.submit()}if(this.auto_focus)focusNextElement()}else{this.input.classList.add("fail");preventActivation(ev,null,this.log);status=false}}else if(final){this.index=0;hideElement(this.list)}ev.preventDefault();ev.stopPropagation();return status};dcLibPredict.prototype.onKey=function(ev){let key=getKeyOfEvent(ev);if(dcLib_DEVELOP)addToLog(this.log,"âŒ¨ dcLibPredict::onKey("+this.name+") type="+ev.type+", key="+ev.key+", code="+ev.code+", keycode="+ev.keycode+" â†’ "+key);if(!this.index){this.save=this.current;this.save.val=getInputData(this.input)}this.input.classList.remove("fail");var index=this.index;if(key=="ArrowUp")this.select(ev,index+this.total);else if(key=="ArrowDown")this.select(ev,index+1);else if(key=="Enter")this.select(ev,index,true);else if(key=="Tab"&&!this.isValid()){console.log(ev);this.input.classList.add("fail");ev.stopPropagation();ev.preventDefault()}else if(key=="Escape"){setInputData(this.input,this.orig);this.list.innerHTML="";hideElement(this.list);if(this.func.end)execFunctionByName(window,this.func.end,this,-1,this.func.arg);ev.stopPropagation();ev.preventDefault()}else if(key===this.add_key)this.onNewRecord(ev);else this.predict=true};dcLibPredict.prototype.onNewRecord=function(ev){let value=this.input.value.trim();addToLog(this.log,"âœ” add record, valid="+this.isValid()+", id="+this.current.id+", value="+value);if(value&&!this.isValid()){this.request_active=true;let query=this.query+"&new=1&text="+encodeURIComponent(this.input.value);let obj=this;requestAjaxObjectP(this.name,query,this.name,this.log,function(log,recv,res){obj.onReceive(log,recv,res)})}ev.stopPropagation();ev.preventDefault()};dcLibPredict.prototype.onReceive=function(log,recv,res){addToLog(this.log,"dcLibPredict::onReceive("+recv.name+"), id="+res.ext.id+", n="+res.ext.n+", show="+res.ext.show_predict+", text="+res.ext.text+", cur="+this.getCurrentWord());showElement(this.list);this.total=res.ext.n;this.index=0;this.request_active=false;if(res.ext.id&&res.ext.text)this.setValid(res.ext.id,res.ext.text,res.ext.info);if(this.getCurrentWord()!==res.ext.text){this.clearCurrent();hideElement(this.list);return}this.setCurrent(this.valid);this.onChangedText();if(this.is_list){let ul=this.list.querySelector("ul");if(ul){let obj=this;for(let i=0;i<ul.childElementCount;i++)ul.childNodes[i].addEventListener("mousedown",function(ev){obj.select(ev,i+1,true)})}}this.store=res.ext.store;if(dcLib_DEVELOP)console.log("store=",this.store);if(res.ext.n&&res.ext.show_predict)showElement(this.list);else hideElement(this.list);if(res.ext.hide)hideShowSelector(res.ext.hide);if(res.ext.show)showSelector(res.ext.show);if(dcLib_DEVELOP)console.log("RECEIVE:",this)};function dcLibModal(settings){let obj=this;this.div_id=createUniqueId()+"-modal";this.name=settings.name;this.form=settings.form;this.location=settings.location;this.next_focus=settings.next_focus;this.job=settings.job;this.uri=settings.uri||window.location.origin+window.location.pathname;if(this.uri.indexOf("?")<0)this.uri+="?ajax="+this.name;dcLib_ModalList.unshift(this);this.prev_target=dcLib_activeElement&&dcLib_activeElement.prev_target;let e=document.getElementById(this.div_id);if(e)removeElement(e);this.frame=document.createElement("div");this.frame.id=this.div_id;this.frame.classList.add("modal");this.frame.style.zIndex=dcLib_ModalList.length+1e3;let inner="<div class=modal-content>";if(!settings.no_close)inner+="<button class=modal-close>Ã—</button>";this.frame.innerHTML=inner+"<div class=modal-body></div></div>";console.log("inner="+this.frame.innerHTML);this.close=this.frame.querySelector(".modal-close");if(this.close)this.close.style.cursor="pointer";this.body=this.frame.querySelector(".modal-body");if(settings.body)this.body.innerHTML=settings.body;console.log("body="+this.body.innerHTML);this.frame.style.display="block";document.body.appendChild(this.frame);this.log=settings.log&&this.body.querySelector(settings.log);registerLocalTooltips();this.frame.addEventListener("keydown",function(ev){obj.onKey(ev)});this.body.addEventListener("dc_findframe",function(ev){obj.onFindFrame(ev)});this.body.addEventListener("dc_leaveframe",function(ev){obj.onLeaveFrame(ev)});if(this.close){this.close.addEventListener("keydown",function(ev){onKeyEnter(ev,obj.onClose)});this.close.addEventListener("click",function(ev){obj.onClose(ev)})}if(!settings.no_buttons){let list=this.body.querySelectorAll("button");for(let i=0;i<list.length;i++){list[i].addEventListener("click",function(ev){obj.onButton(ev)});console.log(list[i])}}let base=this.frame;if(settings.focus){let e=this.body.querySelector(settings.focus);if(e)base=e}let focusable=getFocusableElements(base);this.last_focus=this.entry=focusable.entry;setFocusForce(focusable.entry,true,this.log);console.log(this);addToLog(this.log,"â˜…  dcLibModal("+this.name+") name="+this.name+", form="+this.form)}dcLibModal.prototype.onEvent=function(ev){addToLog(this.log,"â˜Ž dcLibModal::onEvent("+this.name+") event="+ev.type);console.log(ev)};dcLibModal.prototype.onFindFrame=function(ev){addToLog(this.log,"â˜Ž dcLibModal::onFindFrame("+this.name+") event="+ev.type);ev.detail.newframe=this.body;ev.detail.highlight_frame=false;this.last_focus=ev.detail.newtarget};dcLibModal.prototype.onLeaveFrame=function(ev){addToLog(this.log,"â˜Ž dcLibModal::onLeaveFrame("+this.name+") event="+ev.type);if(ev.detail.newframe!==this.body&&dcLib_ModalList.length&&dcLib_ModalList[0]===this){preventActivation(ev,this.entry,this.log)}};dcLibModal.prototype.onClose=function(ev){addToLog(this.log,"â˜Ž dcLibModal::onClose("+this.id+") event="+ev.type);removeElement(this.frame);delete this.frame;delete this.body;if(ev){ev.stopPropagation();ev.preventDefault()}let pos=dcLib_ModalList.indexOf(this);if(pos>=0)dcLib_ModalList.splice(pos,1);if(this.location)window.location=location;if(this.next_focus&&!dcLib_ModalList.length)setFocusForce(this.next_focus);else{let new_focus=this.prev_target;if(dcLib_ModalList.length){let e=dcLib_ModalList[0];if(e.last_focus)new_focus=e.last_focus}if(new_focus)setTimeout(function(){new_focus.focus()},1)}if(this.job)processJob(this.job)};dcLibModal.prototype.onButton=function(ev){addToLog(this.log,"â˜Ž dcLibModal::onButton("+this.name+") event="+ev.type);let ctrl={name:this.name,uri:this.uri,query:"&value="+encodeURIComponent(ev.target.value),log:this.log};if(this.form&&ev.target.form)ctrl.query+=createQueryStringByList(ev.target.form.elements,this.form>1);requestAjaxObject(ctrl);this.onClose(ev)};dcLibModal.prototype.onKey=function(ev){let key=getKeyOfEvent(ev);if(dcLib_DEVELOP)addToLog(this.log,"âŒ¨ dcLibModal::onKey("+this.name+") type="+ev.type+", key="+ev.key+", code="+ev.code+", keycode="+ev.keycode+" â†’ "+key);if(key=="Escape")this.onClose(ev)};function setupModal(){let count=0;forEachSelector("[data-modal]",function(e,a){let list=e.dataset.modal.split(",");delete e.dataset.modal;if(list[0]){let ctrl={type:list[0],idx:list.length>1&&list[1]?parseInt(list[1]):undefined,did:list.length>2&&list[2]?parseInt(list[2]):undefined,aid:list.length>3&&list[3]?list[3]:dcLib_ModalName,eid:list.length>4&&list[4]?list[4]:"modal-x-"+list[0],button:e};if(e.dataset.idx!==undefined)ctrl.idx=parseInt(e.dataset.idx);if(e.dataset.did!==undefined)ctrl.did=parseInt(e.dataset.did);if(e.dataset.aid!==undefined)ctrl.aid=e.dataset.aid;if(e.dataset.eid!==undefined)ctrl.eid=e.dataset.eid;e.onclick=function(ev){doModal(ev,ctrl)};e.onkeydown=function(ev){onKeyEnter(ev,doModal,ctrl)};e.style.cursor="pointer";if(e.tabIndex===-1)e.tabIndex=0;count++}});addToLog("modal-log","setupModal() "+count+" objects initialized");AddAutoUpdate("setupModal",setupModal)}function doModal(ev,ctrl){ctrl.elem=document.getElementById(ctrl.eid);if(!ctrl.elem)return false;ctrl.log="modal-log";ctrl.body=ctrl.elem.querySelector(".modal-body");ctrl.elem.style.display="block";let func="configModal_"+ctrl.type;if(eval("typeof "+func)==="function"&&!window[func](ev,ctrl))return false;ctrl.close=ctrl.elem.querySelectorAll(".modal-close,.modal-abort");for(let i=0;i<ctrl.close.length;i++){ctrl.close[i].onclick=function(){ctrl.elem.style.display="none"};if(ctrl.close[i].tabIndex===-1)ctrl.close[i].tabIndex=0}ctrl.submit=ctrl.elem.querySelectorAll(".modal-submit");if(ctrl.func_submit){for(let i=0;i<ctrl.submit.length;i++){ctrl.submit[i].onclick=function(ev){ctrl.func_submit(ev,ctrl)};if(ctrl.submit[i].tabIndex===-1)ctrl.submit[i].tabIndex=0}}else{if(dcLib_DEVELOP)console.log("disable buttons, n="+ctrl.submit.length);for(let i=0;i<ctrl.submit.length;i++)disableElement(ctrl.submit[i])}ctrl.elem.onkeydown=function(ev){onKeyEscape(ev,cancelModal,ctrl)};if(dcLib_DEVELOP)console.log(ctrl);return true}function cancelModal(ev,ctrl){if(dcLib_DEVELOP)console.log("cancelModal(), key: "+(ev?ev.key:"-"));ctrl.elem.style.display="none"}function updateModal(ctrl,query){let upd=ctrl.button.dataset.upd;if(upd!==undefined||ctrl.idx!==undefined){let q="&j=@update&type="+ctrl.type;if(upd!==undefined)q+="&upd="+upd;if(ctrl.idx!==undefined)q+="&idx="+ctrl.idx;if(ctrl.button.dataset.flags!==undefined)q+="&flags="+ctrl.button.dataset.flags;var request={name:ctrl.aid,query:q+query,log:ctrl.log};requestAjaxObject(request)}return upd}function webauthnCheckValid(){if(typeof dcLib_WebAuthn=="undefined")window.alert("dcLib/WebAuthn: Internal Error!");else if(!dcLib_WebAuthn.is_https)window.alert(dcLib_WebAuthn.msg.https_required);else if(!window.fetch||!navigator.credentials||!navigator.credentials.create||!navigator.credentials.get)window.alert(dcLib_WebAuthn.msg.invalid_browser);else{return true}return false}function webauthnGetLoginCredentials(par,check=false){let e=document.getElementById(dcLib_WebAuthn.id.mode);par.login_mode=e?e.value:null;e=document.getElementById(dcLib_WebAuthn.id.account);par.account=e?e.value:null;e=document.getElementById(dcLib_WebAuthn.id.password);par.password=e?e.value:null;e=document.getElementById(dcLib_WebAuthn.id.totp);par.totp=e?e.value:null;e=document.getElementById(dcLib_WebAuthn.id.recovery);par.recovery=e?e.value:null;e=document.getElementById(dcLib_WebAuthn.id.redirect);par.redirect=e?e.value:null;e=document.getElementById(dcLib_WebAuthn.id.limit_ip);par.limit_ip=e&&e.checked;if(check&&!par.account){webauthnSetLoginStatus("Account required",true,"x-red");setFocus(dcLib_WebAuthn.id.account);return false}return true}async function webauthnLogin(check=false){if(!webauthnCheckValid())return false;let par={webauthnjob:"login"};if(!webauthnGetLoginCredentials(par,check))return;if(dcLib_DEVELOP)console.log("par=",par);let rep=await window.fetch(dcLib_WebAuthn.url,{method:"POST",body:JSON.stringify(par),cache:"no-cache"});const response=await rep.json();if(response.job)processJob(response.job,dcLib_WebAuthn.log)}async function webauthnJob(job){if(!webauthnCheckValid())return false;let par={webauthnjob:job,step:0};while(true){let rep=await window.fetch(dcLib_WebAuthn.url,{method:"POST",body:JSON.stringify(par),cache:"no-cache"});const response=await rep.json();if(response.job)processJob(response.job,dcLib_WebAuthn.log);if(!response.continue)return;par.step++}}async function webauthnAddKey(){if(!webauthnCheckValid())return false;let par={webauthnjob:"getCreateArgs"};let rep=await window.fetch(dcLib_WebAuthn.url,{method:"POST",body:JSON.stringify(par),cache:"no-cache"});let createArgs=await rep.json();addToLog(dcLib_WebAuthn.log,"respone: getCreateArgs");if(createArgs.job){processJob(createArgs.job,dcLib_WebAuthn.log);delete createArgs.job}if(!createArgs.success)return false;webauthnDecodeBinary(createArgs);var promise=navigator.credentials.create(createArgs);var cancel=false;promise=promise.then(resp=>{return resp}).catch(resp=>{window.alert(dcLib_WebAuthn.msg.err_register_key);cancel=true;return false});promise.then(resp=>{if(resp===undefined)return false;if(resp===false)return resp;var key_info=window.prompt(dcLib_WebAuthn.msg.enter_info,"");if(key_info===undefined||key_info===null){cancel=true;return false}return{webauthnjob:"register",clientDataJSON:resp.response.clientDataJSON?webauthnEncodeBinary(resp.response.clientDataJSON):null,attestationObject:resp.response.attestationObject?webauthnEncodeBinary(resp.response.attestationObject):null,keyInfo:key_info}}).then(resp=>{if(resp===false)return resp;return JSON.stringify(resp)}).then(resp=>{if(resp===false)return resp;return window.fetch(dcLib_WebAuthn.url,{method:"POST",body:resp,cache:"no-cache"})}).then(resp=>{if(resp===false)return resp;return resp.json()}).then(json=>{if(json===false)return resp;if(json.success){window.alert(dcLib_WebAuthn.msg.ok_register);window.location=dcLib_WebAuthn.url}else throw new Error(json.msg)}).catch(err=>{if(!cancel)window.alert(err.message||dcLib_WebAuthn.msg.err_unknown)})}async function webauthnCheckKey(mode,check=false){if(!webauthnCheckValid())return false;let is_login=mode<0;dcLib_WebAuthn.log=addToLog(dcLib_WebAuthn.log,"webauthnCheckKey()");try{let par={webauthnjob:"getArgs",mode:mode};if(is_login){addToLog(dcLib_WebAuthn.log,"login: check key");webauthnSetLoginStatus("Check Security Key");if(!webauthnGetLoginCredentials(par,check))return false}if(dcLib_DEVELOP)console.log("par=",par);let rep=await window.fetch(dcLib_WebAuthn.url,{method:"POST",body:JSON.stringify(par),cache:"no-cache"});let getArgs=await rep.json();addToLog(dcLib_WebAuthn.log,"respone: getArgs");if(getArgs.job){processJob(getArgs.job,dcLib_WebAuthn.log);delete getArgs.job}if(getArgs.success===false)throw new Error(getArgs.msg);if(dcLib_DEVELOP)console.log("getArgs3=",getArgs);webauthnDecodeBinary(getArgs);const cred=await navigator.credentials.get(getArgs);if(dcLib_DEVELOP)console.log("cred=",cred);const par2={webauthnjob:"processGet",mode:mode,account:par.account,password:par.password,id:cred.rawId?webauthnEncodeBinary(cred.rawId):null,clientDataJSON:cred.response.clientDataJSON?webauthnEncodeBinary(cred.response.clientDataJSON):null,authenticatorData:cred.response.authenticatorData?webauthnEncodeBinary(cred.response.authenticatorData):null,signature:cred.response.signature?webauthnEncodeBinary(cred.response.signature):null,userHandle:cred.response.userHandle?webauthnEncodeBinary(cred.response.userHandle):null};rep=await window.fetch(dcLib_WebAuthn.url,{method:"POST",body:JSON.stringify(par2),cache:"no-cache"});let response=await rep.json();if(response.job)processJob(response.job,dcLib_WebAuthn.log);if(updateWebauthnPager)updateWebauthnPager();if(response.success){if(is_login){webauthnSetLoginStatus(dcLib_WebAuthn.msg.key_accepted,true,"x-green");const parx={webauthnjob:"success",mode:mode};rep=await window.fetch(dcLib_WebAuthn.url,{method:"POST",body:JSON.stringify(parx),cache:"no-cache"});let response=await rep.json();addToLog(dcLib_WebAuthn.log,"success respone: response");if(response.job)processJob(response.job,dcLib_WebAuthn.log)}else window.alert(dcLib_WebAuthn.msg.key_accepted)}else{throw new Error(response.msg)}}catch(err){console.log(err);if(is_login){webauthnSetLoginStatus(dcLib_WebAuthn.msg.key_rejected,true,"x-red");const parx={webauthnjob:"fail",mode:mode};let rep=await window.fetch(dcLib_WebAuthn.url,{method:"POST",body:JSON.stringify(parx),cache:"no-cache"});let response=await rep.json();addToLog(dcLib_WebAuthn.log,"fail respone: response");if(response.job)processJob(response.job,dcLib_WebAuthn.log)}else window.alert(dcLib_WebAuthn.msg.key_rejected)}}function webauthnDecodeBinary(obj){let prefix="=?BINARY?B?";let suffix="?=";if(typeof obj==="object"){for(let key in obj){if(typeof obj[key]==="string"){let str=obj[key];if(str.substring(0,prefix.length)===prefix&&str.substring(str.length-suffix.length)===suffix){str=str.substring(prefix.length,str.length-suffix.length);let binary_string=window.atob(str);let len=binary_string.length;let bytes=new Uint8Array(len);for(let i=0;i<len;i++)bytes[i]=binary_string.charCodeAt(i);obj[key]=bytes.buffer}}else webauthnDecodeBinary(obj[key])}}}function webauthnEncodeBinary(buffer){let binary="";let bytes=new Uint8Array(buffer);let len=bytes.byteLength;for(let i=0;i<len;i++)binary+=String.fromCharCode(bytes[i]);return window.btoa(binary)}function webauthnSetLoginStatus(msg,alert=false,cls=null){console.log(">>>>> "+msg);let e=document.getElementById(dcLib_WebAuthn.id.status);if(e){e.innerHTML=msg||"â€”";if(cls==null)clearClassElement(e);else setClassElement(e,cls)}else if(alert&&msg)window.alert(msg)}